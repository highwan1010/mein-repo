<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stellen-Details - ID VERMITTLUNG</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo"><i class="fas fa-briefcase"></i><span>VERMITTLUNG</span></div>
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="window.location.href='index.html'">Zur Vermittlungsübersicht</button>
                    <button class="btn-primary" onclick="window.location.href='dashboard.html'">Dashboard</button>
                </div>
            </div>
        </div>
    </nav>

    <main style="padding: 30px 0;">
        <div class="container">
            <div id="content" class="card">Lade Job...</div>
            <section class="card" id="applyCard" style="display:none;">
                <h2 style="margin-bottom: 10px;">Jetzt auf Stelle bewerben</h2>
                <form id="applyForm">
                    <div class="form-group">
                        <label for="anschreiben">Anschreiben</label>
                        <textarea id="anschreiben" class="form-input" rows="6" required placeholder="Beschreiben Sie kurz Ihre Motivation und Qualifikation..."></textarea>
                    </div>
                    <button type="submit" class="btn-success"><i class="fas fa-paper-plane"></i> Bewerbung absenden</button>
                    <button type="button" class="btn-outline" id="favBtn"><i class="fas fa-star"></i> Als Favorit speichern</button>
                </form>
            </section>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        let currentJob = null;
        let isAuthenticated = false;
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL)
            ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '')
            : '';

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Fehler');
            return data;
        }

        async function loadJob() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (!id) {
                document.getElementById('content').innerHTML = 'Ungültige Job-ID';
                return;
            }

            const result = await api(`/api/jobs/${id}`);
            currentJob = result.job;

            document.title = `${currentJob.titel} - ID VERMITTLUNG`;
            document.getElementById('content').innerHTML = `
                <h1 style="margin-bottom: 8px;">${escapeHtml(currentJob.titel)}</h1>
                <p style="color:var(--gray); margin-bottom: 14px;">${escapeHtml(currentJob.firma)} • ${escapeHtml(currentJob.standort)}</p>
                <div class="job-details" style="margin-bottom: 14px;">
                    <span><i class="fas fa-briefcase"></i> ${escapeHtml(currentJob.job_typ)}</span>
                    ${currentJob.kategorie ? `<span><i class="fas fa-layer-group"></i> ${escapeHtml(currentJob.kategorie)}</span>` : ''}
                    ${currentJob.branche ? `<span><i class="fas fa-industry"></i> ${escapeHtml(currentJob.branche)}</span>` : ''}
                    ${(currentJob.gehalt_von || currentJob.gehalt_bis) ? `<span><i class="fas fa-euro-sign"></i> ${currentJob.gehalt_von || 0}€ - ${currentJob.gehalt_bis || 0}€</span>` : ''}
                </div>
                <h3>Beschreibung</h3>
                <p style="margin: 8px 0 14px; white-space: pre-wrap;">${escapeHtml(currentJob.beschreibung)}</p>
                ${currentJob.anforderungen ? `<h3>Anforderungen</h3><p style="margin:8px 0 14px; white-space: pre-wrap;">${escapeHtml(currentJob.anforderungen)}</p>` : ''}
                ${currentJob.benefits ? `<h3>Benefits</h3><p style="margin:8px 0 0; white-space: pre-wrap;">${escapeHtml(currentJob.benefits)}</p>` : ''}
            `;
        }

        async function loadSession() {
            try {
                const session = await api('/api/check-session');
                isAuthenticated = session.isAuthenticated;
                if (isAuthenticated) {
                    const user = await api('/api/user');
                    if (user.user_typ === 'bewerber') {
                        document.getElementById('applyCard').style.display = 'block';
                    }
                }
            } catch {
                isAuthenticated = false;
            }
        }

        document.getElementById('applyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            try {
                await api('/api/bewerbungen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jobId: currentJob.id,
                        anschreiben: document.getElementById('anschreiben').value
                    })
                });
                alert('Bewerbung erfolgreich eingereicht.');
                document.getElementById('anschreiben').value = '';
            } catch (err) {
                alert(err.message);
            }
        });

        document.getElementById('favBtn').addEventListener('click', async () => {
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            try {
                await api('/api/favoriten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId: currentJob.id })
                });
                alert('Job als Favorit gespeichert.');
            } catch (err) {
                alert(err.message);
            }
        });

        (async () => {
            try {
                await loadJob();
                await loadSession();
            } catch (err) {
                document.getElementById('content').textContent = err.message;
            }
        })();
    </script>
    <script src="chat-widget.js"></script>
</body>
</html>
