<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID VERMITTLUNG - Moderne Jobvermittlung</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo">
                    <i class="fas fa-briefcase"></i>
                    <span>VERMITTLUNG</span>
                </div>
                <ul class="nav-menu">
                    <li><a href="#home">Home</a></li>
                    <li><a href="jobs.html">Jobs</a></li>
                    <li><a href="#bewerbungstermine">Termin buchen</a></li>
                    <li><a href="#kontakt">Kontakt</a></li>
                </ul>
                <div class="nav-buttons">
                    <span id="loggedInAs" style="display:none; align-items:center; color: var(--gray-dark); font-weight: 600;"></span>
                    <button class="btn-secondary" id="loginBtn" onclick="window.location.href='login.html'">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="btn-primary" id="registerBtn" onclick="window.location.href='register.html'">
                        <i class="fas fa-user-plus"></i> Registrieren
                    </button>
                </div>
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="container">
            <div class="hero-content">
                <h1>Ihre <span class="highlight">Jobvermittlung</span> für den nächsten Karriereschritt</h1>
                <p class="hero-subtitle">Finden Sie passende Stellen, bewerben Sie sich direkt online und verfolgen Sie Ihren Vermittlungsstatus transparent im Dashboard.</p>
                <div class="feature-list" style="margin-top: 16px; margin-bottom: 0;">
                    <div class="feature-item">
                        <i class="fas fa-compass"></i>
                        <div>
                            <h4>Passende Vermittlung</h4>
                            <p>Alle relevanten Stelleninformationen kompakt und verständlich an einem Ort.</p>
                        </div>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-list-check"></i>
                        <div>
                            <h4>Klare nächste Schritte</h4>
                            <p>Im Dashboard sehen Sie Aufgaben und setzen Ihre nächsten Vermittlungsschritte gezielt um.</p>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:18px; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="window.location.href='jobs.html'">Zu den Jobs</button>
                    <button class="btn-secondary" onclick="window.location.href='register.html'">Kostenlos registrieren</button>
                    <button class="btn-secondary" onclick="document.getElementById('bewerbungstermine').scrollIntoView({ behavior: 'smooth' })">Termin buchen</button>
                </div>
            </div>

            <div>
                <div class="image-placeholder" style="min-height: 320px; font-size: 82px; margin-bottom: 14px;">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="job-card">
                    <h3 style="margin-bottom: 10px;"><i class="fas fa-lightbulb"></i> Ihr Vermittlungs-Start</h3>
                    <p style="margin-bottom: 10px;">Öffnen Sie den Tab <strong>Jobs</strong>, wählen Sie passende Stellen und starten Sie Ihre Bewerbung direkt online.</p>
                    <p style="color: var(--gray); margin: 0;">Danach behalten Sie alle Schritte, Aufgaben und Status zentral im Dashboard im Blick.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="jobs-section" id="bewerbungstermine">
        <div class="container">
            <div class="section-header">
                <h2>Termin buchen</h2>
                <p>Wählen Sie hier modern und schnell Ihr Datum und Ihre Uhrzeit aus.</p>
            </div>

            <div class="card appointments-booking-card">
                <div id="appointmentsLoginHint" class="appointments-login-hint" style="display:none;">
                    Bitte zuerst einloggen, um einen Termin zu buchen.
                </div>
                <div id="appointmentsPublicAlert"></div>
                <form id="appointmentsPublicForm" class="appointments-booking-form">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="appointmentsPublicName">Name</label>
                            <input class="form-input" id="appointmentsPublicName" type="text" maxlength="140" required />
                        </div>
                        <div class="form-group">
                            <label for="appointmentsPublicEmail">E-Mail</label>
                            <input class="form-input" id="appointmentsPublicEmail" type="email" maxlength="140" required />
                        </div>
                    </div>
                    <div class="appointment-picker-layout" id="appointmentsPickerRoot">
                        <div class="appointment-picker-field">
                            <div class="appointment-picker-header-row">
                                <button class="btn-secondary appointment-nav-btn" id="appointmentMonthPrev" type="button" onclick="changeAppointmentMonth(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="appointment-month-label" id="appointmentCalendarMonth">Monat</div>
                                <button class="btn-secondary appointment-nav-btn" id="appointmentMonthNext" type="button" onclick="changeAppointmentMonth(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="appointment-weekdays">
                                <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
                            </div>
                            <div class="appointment-calendar-grid" id="appointmentCalendarGrid"></div>
                        </div>
                        <div class="appointment-picker-field">
                            <label>Uhrzeit auswählen</label>
                            <div class="appointment-time-slots" id="appointmentTimeSlots"></div>
                        </div>
                    </div>
                    <input id="appointmentsPublicDate" type="hidden" required />
                    <input id="appointmentsPublicTime" type="hidden" required />
                    <button class="btn-primary" id="appointmentsPublicSubmit" type="submit">
                        <i class="fas fa-calendar-check"></i> Termin buchen
                    </button>
                </form>

                <h3 style="margin-bottom: 10px;">Meine Termine</h3>
                <div id="appointmentsPublicList">Bitte einloggen, um Termine zu sehen und zu buchen.</div>
            </div>
        </div>
    </section>

    <section class="jobs-section">
        <div class="container">
            <div class="section-header">
                <h2>So funktioniert die Jobvermittlung</h2>
                <p>Alle Schritte von der Auswahl bis zur Bewerbung auf einen Blick</p>
            </div>

            <div class="feature-list" style="max-width: 900px; margin: 0 auto;">
                <div class="feature-item">
                    <i class="fas fa-user-plus"></i>
                    <div>
                        <h4>Konto erstellen</h4>
                        <p>Registrieren Sie sich kostenlos und vervollständigen Sie Ihr Profil in wenigen Minuten.</p>
                    </div>
                </div>
                <div class="feature-item">
                    <i class="fas fa-briefcase"></i>
                    <div>
                        <h4>Jobs im Tab „Jobs“ entdecken</h4>
                        <p>Alle offenen Stellen finden Sie zentral im oberen Tab „Jobs“ mit allen Details.</p>
                    </div>
                </div>
                <div class="feature-item">
                    <i class="fas fa-paper-plane"></i>
                    <div>
                        <h4>Schnell bewerben</h4>
                        <p>Bewerben Sie sich direkt online und behalten Sie den Bewerbungsstatus im Dashboard im Blick.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="jobs-section">
        <div class="container">
            <div class="section-header">
                <h2>Warum ID VERMITTLUNG?</h2>
                <p>Mehr Transparenz und klare Abläufe für Ihre nächste berufliche Chance</p>
            </div>

            <div class="jobs-grid">
                <div class="job-card">
                    <h3 style="margin-bottom: 10px;"><i class="fas fa-clock"></i> Aktuelle Vermittlungsstellen</h3>
                    <p>Alle Ausschreibungen sind aktuell und werden zentral im Adminpanel gepflegt.</p>
                </div>
                <div class="job-card">
                    <h3 style="margin-bottom: 10px;"><i class="fas fa-shield-alt"></i> Strukturierter Ablauf</h3>
                    <p>Transparente Vermittlungsprozesse und ein zentraler Status für jede Bewerbung.</p>
                </div>
                <div class="job-card">
                    <h3 style="margin-bottom: 10px;"><i class="fas fa-chart-line"></i> Besserer Überblick</h3>
                    <p>Dashboard, Favoriten und Stellen-Details helfen bei schnellen Entscheidungen.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="jobs-section" id="kontakt">
        <div class="container">
            <div class="section-header">
                <h2>Kontakt</h2>
                <p>Sie haben Fragen zur Plattform? Wir helfen gerne weiter.</p>
            </div>

            <div class="card" style="max-width: 760px; margin: 0 auto;">
                <p><strong>E-Mail:</strong> support@id-vermittlung.de</p>
                <p><strong>Antwortzeit:</strong> innerhalb von 24 Stunden</p>
                <p><strong>Hinweis:</strong> Neue Vermittlungsstellen finden Sie im oberen Tab <strong>Jobs</strong>.</p>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
        <div class="container">
            <div class="cta-content">
                <h2>Bereit für Ihre nächste berufliche Chance?</h2>
                <p>Registrieren Sie sich kostenlos und starten Sie jetzt Ihre Jobvermittlung!</p>
                <button class="btn-primary btn-large" onclick="window.location.href='register.html'">
                    Jetzt kostenlos registrieren
                </button>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <div class="footer-logo">
                        <i class="fas fa-briefcase"></i>
                        <span>VERMITTLUNG</span>
                    </div>
                    <p>Die moderne Vermittlungsplattform für Bewerber und Arbeitgeber mit klaren Prozessen.</p>
                </div>
                <div class="footer-column">
                    <h4>Für Bewerber</h4>
                    <ul>
                        <li><a href="jobs.html">Jobs suchen</a></li>
                        <li><a href="register.html">Registrieren</a></li>
                        <li><a href="login.html">Login</a></li>
                        <li><a href="#">Karriere-Tipps</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>Unternehmen</h4>
                    <ul>
                        <li><a href="#">Über uns</a></li>
                        <li><a href="#kontakt">Kontakt</a></li>
                        <li><a href="#">Impressum</a></li>
                        <li><a href="#">Datenschutz</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 ID VERMITTLUNG. Alle Rechte vorbehalten.</p>
            </div>
        </div>
    </footer>

    <script src="config.js"></script>
    <script>
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL)
            ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '')
            : '';
        const APPOINTMENT_TIME_SLOTS = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];

        let currentSessionUser = null;
        let appointmentPickerEnabled = false;
        let appointmentCalendarDate = new Date();
        let selectedAppointmentDate = '';
        let selectedAppointmentTime = '09:00';

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Fehler');
            return data;
        }

        function showAppointmentsPublicAlert(message, type = 'error') {
            const alertElement = document.getElementById('appointmentsPublicAlert');
            if (!alertElement) return;
            alertElement.innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function toDateInputValue(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function applyAppointmentSelection() {
            const dateInput = document.getElementById('appointmentsPublicDate');
            const timeInput = document.getElementById('appointmentsPublicTime');
            if (dateInput) dateInput.value = selectedAppointmentDate;
            if (timeInput) timeInput.value = selectedAppointmentTime;
        }

        function changeAppointmentMonth(delta) {
            appointmentCalendarDate = new Date(appointmentCalendarDate.getFullYear(), appointmentCalendarDate.getMonth() + Number(delta), 1);
            renderAppointmentCalendar();
        }

        function selectAppointmentDate(dateValue) {
            selectedAppointmentDate = dateValue;
            applyAppointmentSelection();
            renderAppointmentCalendar();
        }

        function selectAppointmentTime(timeValue) {
            selectedAppointmentTime = timeValue;
            applyAppointmentSelection();
            renderAppointmentTimeSlots();
        }

        function renderAppointmentCalendar() {
            const monthLabel = document.getElementById('appointmentCalendarMonth');
            const grid = document.getElementById('appointmentCalendarGrid');
            if (!monthLabel || !grid) return;

            const year = appointmentCalendarDate.getFullYear();
            const monthIndex = appointmentCalendarDate.getMonth();
            monthLabel.textContent = new Intl.DateTimeFormat('de-DE', { month: 'long', year: 'numeric' }).format(new Date(year, monthIndex, 1));

            const firstOfMonth = new Date(year, monthIndex, 1);
            const firstWeekDay = (firstOfMonth.getDay() + 6) % 7;
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const todayValue = toDateInputValue(new Date());

            const cells = [];
            for (let i = 0; i < firstWeekDay; i += 1) {
                cells.push('<button class="appointment-day-btn empty" type="button" disabled></button>');
            }

            for (let day = 1; day <= daysInMonth; day += 1) {
                const current = new Date(year, monthIndex, day);
                const dateValue = toDateInputValue(current);
                const isPast = dateValue < todayValue;
                const isSelected = dateValue === selectedAppointmentDate;
                const classNames = ['appointment-day-btn'];
                if (isSelected) classNames.push('selected');
                if (isPast || !appointmentPickerEnabled) classNames.push('disabled');

                cells.push(`
                    <button
                        class="${classNames.join(' ')}"
                        type="button"
                        ${isPast || !appointmentPickerEnabled ? 'disabled' : ''}
                        onclick="selectAppointmentDate('${dateValue}')"
                    >${day}</button>
                `);
            }

            grid.innerHTML = cells.join('');
        }

        function renderAppointmentTimeSlots() {
            const slots = document.getElementById('appointmentTimeSlots');
            if (!slots) return;

            slots.innerHTML = APPOINTMENT_TIME_SLOTS.map((timeValue) => {
                const classNames = ['appointment-time-slot'];
                if (timeValue === selectedAppointmentTime) classNames.push('selected');
                if (!appointmentPickerEnabled) classNames.push('disabled');

                return `
                    <button
                        class="${classNames.join(' ')}"
                        type="button"
                        ${appointmentPickerEnabled ? '' : 'disabled'}
                        onclick="selectAppointmentTime('${timeValue}')"
                    >${timeValue}</button>
                `;
            }).join('');
        }

        function initializeAppointmentPicker() {
            const today = new Date();
            appointmentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
            selectedAppointmentDate = toDateInputValue(today);
            if (!APPOINTMENT_TIME_SLOTS.includes(selectedAppointmentTime)) {
                selectedAppointmentTime = APPOINTMENT_TIME_SLOTS[0] || '';
            }

            applyAppointmentSelection();
            renderAppointmentCalendar();
            renderAppointmentTimeSlots();
        }

        function setAppointmentsAvailability(isEnabled, message = '') {
            const form = document.getElementById('appointmentsPublicForm');
            const submitButton = document.getElementById('appointmentsPublicSubmit');
            const nameInput = document.getElementById('appointmentsPublicName');
            const emailInput = document.getElementById('appointmentsPublicEmail');
            const dateInput = document.getElementById('appointmentsPublicDate');
            const timeInput = document.getElementById('appointmentsPublicTime');
            const pickerRoot = document.getElementById('appointmentsPickerRoot');
            const list = document.getElementById('appointmentsPublicList');
            const loginHint = document.getElementById('appointmentsLoginHint');

            if (!form || !submitButton || !nameInput || !emailInput || !dateInput || !timeInput || !pickerRoot || !list || !loginHint) return;

            appointmentPickerEnabled = Boolean(isEnabled);

            submitButton.disabled = !isEnabled;
            nameInput.disabled = !isEnabled;
            emailInput.disabled = !isEnabled;
            dateInput.disabled = !isEnabled;
            timeInput.disabled = !isEnabled;
            pickerRoot.classList.toggle('disabled', !isEnabled);
            renderAppointmentCalendar();
            renderAppointmentTimeSlots();

            if (!isEnabled) {
                loginHint.textContent = message || 'Bitte zuerst einloggen, um einen Termin zu buchen.';
                loginHint.style.display = 'block';
                list.innerHTML = '<p>Bitte einloggen, um Termine zu sehen.</p>';
            } else {
                loginHint.style.display = 'none';
            }
        }

        async function loadPublicAppointments() {
            const list = document.getElementById('appointmentsPublicList');
            if (!list || !currentSessionUser) return;

            list.innerHTML = 'Lade Termine...';
            try {
                const response = await api('/api/termine');
                const termine = (response.termine || []).slice().sort((left, right) => {
                    const leftDate = new Date(left.termin_zeit).getTime();
                    const rightDate = new Date(right.termin_zeit).getTime();
                    return leftDate - rightDate;
                });

                list.innerHTML = termine.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>E-Mail</th>
                                <th>Datum</th>
                                <th>Uhrzeit</th>
                                <th>Erstellt</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${termine.map((termin) => `
                                <tr>
                                    <td>${escapeHtml(termin.name || '—')}</td>
                                    <td>${escapeHtml(termin.email || '—')}</td>
                                    <td><input class="form-input" id="terminDate-${Number(termin.id)}" type="date" value="${escapeHtml(termin.datum || '')}" /></td>
                                    <td><input class="form-input" id="terminTime-${Number(termin.id)}" type="time" value="${escapeHtml(termin.uhrzeit || '')}" /></td>
                                    <td>${termin.erstellt_am ? new Date(termin.erstellt_am).toLocaleString('de-DE') : '—'}</td>
                                    <td>
                                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                            <button class="btn-secondary" type="button" onclick="rescheduleAppointment(${Number(termin.id)})">Verschieben</button>
                                            <button class="btn-danger" type="button" onclick="cancelAppointment(${Number(termin.id)})">Abbrechen</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Noch keine Termine gebucht.</p>';
            } catch (error) {
                list.innerHTML = '<p>Termine konnten nicht geladen werden.</p>';
            }
        }

        async function rescheduleAppointment(terminId) {
            const dateInput = document.getElementById(`terminDate-${Number(terminId)}`);
            const timeInput = document.getElementById(`terminTime-${Number(terminId)}`);

            if (!dateInput || !timeInput) {
                showAppointmentsPublicAlert('Termin konnte nicht geladen werden.');
                return;
            }

            const datum = String(dateInput.value || '').trim();
            const uhrzeit = String(timeInput.value || '').trim();

            if (!datum || !uhrzeit) {
                showAppointmentsPublicAlert('Bitte Datum und Uhrzeit auswählen.');
                return;
            }

            try {
                await api(`/api/termine/${Number(terminId)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ datum, uhrzeit })
                });

                showAppointmentsPublicAlert('Termin erfolgreich verschoben.', 'success');
                await loadPublicAppointments();
            } catch (error) {
                showAppointmentsPublicAlert(error.message || 'Termin konnte nicht verschoben werden.');
            }
        }

        async function cancelAppointment(terminId) {
            const confirmed = confirm('Diesen Termin wirklich abbrechen?');
            if (!confirmed) return;

            try {
                await api(`/api/termine/${Number(terminId)}`, { method: 'DELETE' });
                showAppointmentsPublicAlert('Termin wurde abgebrochen.', 'success');
                await loadPublicAppointments();
            } catch (error) {
                showAppointmentsPublicAlert(error.message || 'Termin konnte nicht abgebrochen werden.');
            }
        }

        async function updateNavForSession() {
            try {
                const response = await fetch(`${API_BASE}/api/check-session`);
                const data = await response.json();

                if (!data.isAuthenticated) {
                    setAppointmentsAvailability(false, 'Bitte zuerst einloggen, um einen Termin zu buchen.');
                    return;
                }

                let currentUser = null;
                try {
                    const userResponse = await fetch(`${API_BASE}/api/user`);
                    if (userResponse.ok) {
                        currentUser = await userResponse.json();
                    }
                } catch (userError) {
                    console.error('Fehler beim Laden des Benutzers:', userError);
                }

                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                const loggedInAs = document.getElementById('loggedInAs');

                if (loggedInAs && currentUser) {
                    const fullName = `${currentUser.vorname || ''} ${currentUser.nachname || ''}`.trim();
                    loggedInAs.textContent = `Eingeloggt als: ${fullName || currentUser.email || 'Benutzer'}`;
                    loggedInAs.style.display = 'inline-flex';
                }

                if (loginBtn) {
                    loginBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i> Dashboard';
                    loginBtn.onclick = () => {
                        window.location.href = 'dashboard.html';
                    };
                }

                if (registerBtn) {
                    registerBtn.style.display = 'none';
                }

                currentSessionUser = currentUser;
                setAppointmentsAvailability(true);

                if (currentUser) {
                    const fullName = `${currentUser.vorname || ''} ${currentUser.nachname || ''}`.trim();
                    document.getElementById('appointmentsPublicName').value = fullName;
                    document.getElementById('appointmentsPublicEmail').value = currentUser.email || '';
                }

                await loadPublicAppointments();
            } catch (error) {
                console.error('Fehler beim Prüfen der Session:', error);
                setAppointmentsAvailability(false, 'Bitte zuerst einloggen, um einen Termin zu buchen.');
            }
        }

        document.getElementById('appointmentsPublicForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                name: document.getElementById('appointmentsPublicName').value.trim(),
                email: document.getElementById('appointmentsPublicEmail').value.trim(),
                datum: document.getElementById('appointmentsPublicDate').value,
                uhrzeit: document.getElementById('appointmentsPublicTime').value
            };

            try {
                await api('/api/termine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showAppointmentsPublicAlert('Termin erfolgreich gebucht.', 'success');
                document.getElementById('appointmentsPublicDate').value = '';
                document.getElementById('appointmentsPublicTime').value = '';
                await loadPublicAppointments();
            } catch (error) {
                showAppointmentsPublicAlert(error.message || 'Termin konnte nicht gebucht werden.');
            }
        });

        // Init
        initializeAppointmentPicker();
        updateNavForSession();
    </script>
    <script src="chat-widget.js"></script>
</body>
</html>
