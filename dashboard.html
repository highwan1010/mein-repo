<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - JobVermittlung</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo"><i class="fas fa-briefcase"></i><span>JobVermittlung</span></div>
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="window.location.href='index.html'">Startseite</button>
                    <button class="btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-top">
                <div>
                    <h1 id="welcome">Dashboard</h1>
                    <p id="subtitle" style="color: var(--gray);"></p>
                </div>
                <div class="badge" id="userBadge">Laden...</div>
            </div>

            <div class="panel-grid">
                <div class="panel">
                    <div style="color: var(--gray);">Meine Jobs</div>
                    <div class="value" id="countJobs">0</div>
                </div>
                <div class="panel">
                    <div style="color: var(--gray);">Meine Bewerbungen</div>
                    <div class="value" id="countBewerbungen">0</div>
                </div>
                <div class="panel">
                    <div style="color: var(--gray);">Gespeicherte Jobs</div>
                    <div class="value" id="countFavoriten">0</div>
                </div>
            </div>

            <section class="card" id="arbeitgeberActions" style="display:none;">
                <h2 style="margin-bottom: 10px;">Job erstellen</h2>
                <form id="jobForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="titel">Titel</label>
                            <input class="form-input" id="titel" required />
                        </div>
                        <div class="form-group">
                            <label for="firma">Firma</label>
                            <input class="form-input" id="firma" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="standort">Standort</label>
                            <input class="form-input" id="standort" required />
                        </div>
                        <div class="form-group">
                            <label for="jobTyp">Beschäftigungsart</label>
                            <select class="form-input" id="jobTyp" required>
                                <option>Vollzeit</option>
                                <option>Teilzeit</option>
                                <option>Freelance</option>
                                <option>Remote</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="kategorie">Kategorie</label>
                            <input class="form-input" id="kategorie" placeholder="IT & Software" />
                        </div>
                        <div class="form-group">
                            <label for="branche">Branche</label>
                            <input class="form-input" id="branche" placeholder="Technologie" />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="gehaltVon">Gehalt von (€)</label>
                            <input class="form-input" id="gehaltVon" type="number" min="0" />
                        </div>
                        <div class="form-group">
                            <label for="gehaltBis">Gehalt bis (€)</label>
                            <input class="form-input" id="gehaltBis" type="number" min="0" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="erfahrung">Erfahrung</label>
                        <input class="form-input" id="erfahrung" placeholder="2-4 Jahre" />
                    </div>
                    <div class="form-group">
                        <label for="beschreibung">Beschreibung</label>
                        <textarea class="form-input" id="beschreibung" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="anforderungen">Anforderungen</label>
                        <textarea class="form-input" id="anforderungen" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="benefits">Benefits</label>
                        <textarea class="form-input" id="benefits" rows="3"></textarea>
                    </div>
                    <button class="btn-success" type="submit"><i class="fas fa-plus"></i> Job veröffentlichen</button>
                </form>
            </section>

            <section class="card">
                <div style="display:flex; gap:10px; margin-bottom: 12px;">
                    <button class="btn-primary" id="tabMainBtn" type="button" onclick="switchDashboardTab('main')">Übersicht</button>
                    <button class="btn-secondary" id="tabTasksBtn" type="button" onclick="switchDashboardTab('tasks')">Aufgaben</button>
                </div>

                <div id="mainTabPane">
                    <h2 style="margin-bottom: 10px;" id="listTitle">Meine Jobs</h2>
                    <div id="listContainer">Lade Daten...</div>
                    <div id="bewerberCalendarSection" style="margin-top: 16px;" data-section="bewerbungstermine">
                        <h2 style="margin-bottom: 10px;">Bewerbungstermine</h2>
                        <p style="color: var(--gray); margin-bottom: 10px;">Wählen Sie Datum und Uhrzeit für Ihr Bewerbungsgespräch.</p>
                        <div id="appointmentsAlert"></div>
                        <form id="appointmentForm" style="margin-bottom: 14px;">
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="appointmentName">Name</label>
                                    <input class="form-input" id="appointmentName" type="text" maxlength="140" required />
                                </div>
                                <div class="form-group">
                                    <label for="appointmentEmail">E-Mail</label>
                                    <input class="form-input" id="appointmentEmail" type="email" maxlength="140" required />
                                </div>
                            </div>
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="appointmentDate">Datum</label>
                                    <input class="form-input" id="appointmentDate" type="date" required />
                                </div>
                                <div class="form-group">
                                    <label for="appointmentTime">Uhrzeit</label>
                                    <input class="form-input" id="appointmentTime" type="time" required />
                                </div>
                            </div>
                            <button class="btn-primary" type="submit"><i class="fas fa-calendar-check"></i> Termin buchen</button>
                        </form>
                        <h3 style="margin-bottom: 10px;">Meine gebuchten Termine</h3>
                        <div id="appointmentsContainer">Lade Termine...</div>
                    </div>
                </div>

                <div id="tasksTabPane" style="display:none;">
                    <h2 style="margin-bottom: 10px;">Meine Aufgaben</h2>
                    <div id="tasksContainer">Lade Aufgaben...</div>
                </div>

            </section>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        let currentUser = null;
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL)
            ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '')
            : '';

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function showAppointmentAlert(message, type = 'error') {
            const alertElement = document.getElementById('appointmentsAlert');
            if (!alertElement) return;
            alertElement.innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Fehler');
            return data;
        }

        async function loadCurrentUser() {
            const session = await api('/api/check-session');
            if (!session.isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = await api('/api/user');

            const params = new URLSearchParams(window.location.search);
            const requestedTab = String(params.get('tab') || '').trim().toLowerCase();
            const forceAppointmentsMode = requestedTab === 'appointments';
            const normalizedUserType = String(currentUser.user_typ || '').trim().toLowerCase();
            const isArbeitgeber = normalizedUserType === 'arbeitgeber';
            const isBewerber = normalizedUserType === 'bewerber';

            if (normalizedUserType === 'admin' && !forceAppointmentsMode) {
                window.location.href = 'admin.html';
                return;
            }

            document.getElementById('welcome').textContent = `Hallo, ${currentUser.vorname}!`;

            document.getElementById('subtitle').textContent = isArbeitgeber
                ? 'Verwalten Sie Ihre Stellen und Bewerbungsprozesse.'
                : 'Entdecken Sie passende Stellen und verfolgen Sie Ihren Vermittlungsstatus.';
            document.getElementById('userBadge').textContent = isArbeitgeber
                ? 'Arbeitgeber'
                : (normalizedUserType === 'admin' ? 'Admin' : 'Bewerber');

            if (isArbeitgeber) {
                document.getElementById('arbeitgeberActions').style.display = 'block';
                document.getElementById('listTitle').textContent = 'Meine veröffentlichten Jobs';
                document.getElementById('bewerberCalendarSection').style.display = 'none';
            } else if (isBewerber || forceAppointmentsMode) {
                document.getElementById('listTitle').textContent = 'Meine Bewerbungen';
                document.getElementById('bewerberCalendarSection').style.display = 'block';
                const fullName = `${currentUser.vorname || ''} ${currentUser.nachname || ''}`.trim();
                document.getElementById('appointmentName').value = fullName;
                document.getElementById('appointmentEmail').value = currentUser.email || '';
            } else {
                document.getElementById('bewerberCalendarSection').style.display = 'none';
            }
        }

        async function loadData() {
            if (!currentUser) return;

            if (currentUser.user_typ === 'arbeitgeber') {
                const jobsRes = await api('/api/my-jobs');
                document.getElementById('countJobs').textContent = jobsRes.jobs.length;
                const list = jobsRes.jobs;
                document.getElementById('listContainer').innerHTML = list.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Standort</th>
                                <th>Typ</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(job => `
                                <tr>
                                    <td>${escapeHtml(job.titel)}</td>
                                    <td>${escapeHtml(job.standort)}</td>
                                    <td>${escapeHtml(job.job_typ)}</td>
                                    <td><span class="badge ${job.status === 'aktiv' ? 'success' : 'warning'}">${escapeHtml(job.status)}</span></td>
                                    <td>
                                        <button class="btn-secondary" onclick="openJob(${job.id})">Ansehen</button>
                                        <button class="btn-danger" onclick="deleteJob(${job.id})">Löschen</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Sie haben noch keine Jobs veröffentlicht.</p>';

                document.getElementById('countBewerbungen').textContent = '—';
                document.getElementById('countFavoriten').textContent = '—';
            } else {
                const bew = await api('/api/my-bewerbungen');
                const fav = await api('/api/favoriten');
                document.getElementById('countJobs').textContent = '—';
                document.getElementById('countBewerbungen').textContent = bew.bewerbungen.length;
                document.getElementById('countFavoriten').textContent = fav.favoriten.length;

                document.getElementById('listContainer').innerHTML = bew.bewerbungen.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Job</th>
                                <th>Firma</th>
                                <th>Standort</th>
                                <th>Status</th>
                                <th>Datum</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bew.bewerbungen.map(item => `
                                <tr>
                                    <td>${escapeHtml(item.titel)}</td>
                                    <td>${escapeHtml(item.firma)}</td>
                                    <td>${escapeHtml(item.standort)}</td>
                                    <td><span class="badge">${escapeHtml(item.status)}</span></td>
                                    <td>${new Date(item.erstellt_am).toLocaleDateString('de-DE')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Sie haben noch keine Bewerbungen gesendet.</p>';
            }
        }

        async function loadTasks() {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = 'Lade Aufgaben...';

            try {
                const taskRes = await api('/api/tasks');
                const tasks = taskRes.tasks || [];

                container.innerHTML = tasks.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Beschreibung</th>
                                <th>Status</th>
                                <th>Fällig</th>
                                <th>Admin</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks.map(task => `
                                <tr>
                                    <td>${escapeHtml(task.titel || '—')}</td>
                                    <td>${escapeHtml(task.beschreibung || '—')}</td>
                                    <td><span class="badge ${task.status === 'erledigt' ? 'success' : 'warning'}">${escapeHtml(task.status || 'offen')}</span></td>
                                    <td>${task.faellig_am ? new Date(task.faellig_am).toLocaleDateString('de-DE') : '—'}</td>
                                    <td>${escapeHtml(`${task.admin_vorname || ''} ${task.admin_nachname || ''}`.trim() || task.admin_email || '—')}</td>
                                    <td>
                                        ${task.status !== 'erledigt'
                                            ? `<button class="btn-success" onclick="markTaskDone(${task.id})">Erledigt</button>`
                                            : '<span style="color: var(--success); font-weight:600;">✓</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Keine Aufgaben zugewiesen.</p>';
            } catch (error) {
                container.innerHTML = '<p>Fehler beim Laden der Aufgaben.</p>';
            }
        }

        async function markTaskDone(taskId) {
            try {
                await api(`/api/tasks/${taskId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'erledigt' })
                });
                await loadTasks();
            } catch (error) {
                alert(error.message || 'Aufgabe konnte nicht aktualisiert werden.');
            }
        }

        async function loadAppointments() {
            const container = document.getElementById('appointmentsContainer');
            if (!container || !currentUser || currentUser.user_typ !== 'bewerber') {
                return;
            }

            container.innerHTML = 'Lade Termine...';

            try {
                const response = await api('/api/termine');
                const termine = (response.termine || []).slice().sort((left, right) => {
                    const leftDate = new Date(left.termin_zeit).getTime();
                    const rightDate = new Date(right.termin_zeit).getTime();
                    return leftDate - rightDate;
                });

                container.innerHTML = termine.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>E-Mail</th>
                                <th>Datum</th>
                                <th>Uhrzeit</th>
                                <th>Erstellt</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${termine.map((termin) => `
                                <tr>
                                    <td>${escapeHtml(termin.name || '—')}</td>
                                    <td>${escapeHtml(termin.email || '—')}</td>
                                    <td>${escapeHtml(termin.datum || '—')}</td>
                                    <td>${escapeHtml(termin.uhrzeit || '—')}</td>
                                    <td>${termin.erstellt_am ? new Date(termin.erstellt_am).toLocaleString('de-DE') : '—'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Noch keine Bewerbungstermine gebucht.</p>';
            } catch (error) {
                container.innerHTML = '<p>Fehler beim Laden der Termine.</p>';
            }
        }

        function switchDashboardTab(tab) {
            const mainPane = document.getElementById('mainTabPane');
            const taskPane = document.getElementById('tasksTabPane');
            const mainBtn = document.getElementById('tabMainBtn');
            const tasksBtn = document.getElementById('tabTasksBtn');

            if (tab === 'tasks') {
                mainPane.style.display = 'none';
                taskPane.style.display = 'block';
                mainBtn.className = 'btn-secondary';
                tasksBtn.className = 'btn-primary';
            } else {
                mainPane.style.display = 'block';
                taskPane.style.display = 'none';
                mainBtn.className = 'btn-primary';
                tasksBtn.className = 'btn-secondary';
            }
        }

        function getInitialDashboardTab() {
            const params = new URLSearchParams(window.location.search);
            const tab = String(params.get('tab') || '').trim().toLowerCase();
            if (tab === 'tasks') {
                return tab;
            }
            return 'main';
        }

        async function deleteJob(id) {
            if (!confirm('Job wirklich löschen?')) return;
            try {
                await api(`/api/jobs/${id}`, { method: 'DELETE' });
                await loadData();
            } catch (err) {
                alert(err.message);
            }
        }

        function openJob(id) {
            window.location.href = `job-details.html?id=${id}`;
        }

        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                titel: document.getElementById('titel').value,
                firma: document.getElementById('firma').value,
                standort: document.getElementById('standort').value,
                jobTyp: document.getElementById('jobTyp').value,
                kategorie: document.getElementById('kategorie').value,
                branche: document.getElementById('branche').value,
                gehaltVon: document.getElementById('gehaltVon').value || null,
                gehaltBis: document.getElementById('gehaltBis').value || null,
                erfahrung: document.getElementById('erfahrung').value,
                beschreibung: document.getElementById('beschreibung').value,
                anforderungen: document.getElementById('anforderungen').value,
                benefits: document.getElementById('benefits').value
            };

            try {
                await api('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                e.target.reset();
                await loadData();
                alert('Stelle erfolgreich veröffentlicht.');
            } catch (err) {
                alert(err.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await api('/api/logout', { method: 'POST' });
            window.location.href = 'index.html';
        });

        document.getElementById('appointmentForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                name: document.getElementById('appointmentName').value.trim(),
                email: document.getElementById('appointmentEmail').value.trim(),
                datum: document.getElementById('appointmentDate').value,
                uhrzeit: document.getElementById('appointmentTime').value
            };

            try {
                await api('/api/termine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showAppointmentAlert('Termin erfolgreich gebucht.', 'success');
                document.getElementById('appointmentDate').value = '';
                document.getElementById('appointmentTime').value = '';
                await loadAppointments();
            } catch (error) {
                showAppointmentAlert(error.message || 'Termin konnte nicht gebucht werden.');
            }
        });

        (async () => {
            try {
                await loadCurrentUser();
                await loadData();
                await loadTasks();
                await loadAppointments();

                const params = new URLSearchParams(window.location.search);
                const requestedTab = String(params.get('tab') || '').trim().toLowerCase();
                const initialTab = requestedTab === 'appointments' ? 'main' : getInitialDashboardTab();
                switchDashboardTab(initialTab);

                if (requestedTab === 'appointments' && currentUser && currentUser.user_typ === 'bewerber') {
                    const section = document.querySelector('[data-section="bewerbungstermine"]');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            } catch (err) {
                alert(err.message);
            }
        })();
    </script>
    <script src="chat-widget.js"></script>
</body>
</html>
