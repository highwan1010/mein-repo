<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - JobVermittlung</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .dashboard-chat-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .dashboard-chat-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 12px;
            align-items: start;
        }

        .dashboard-conversation-list {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--white);
            padding: 8px;
            max-height: 520px;
            overflow-y: auto;
        }

        .dashboard-conversation-item {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--white);
            text-align: left;
            padding: 9px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .dashboard-conversation-item.active {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .dashboard-conversation-meta {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 4px;
            color: var(--gray);
            font-size: 12px;
        }

        .dashboard-conversation-preview {
            color: var(--gray);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dashboard-chat-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            font-size: 13px;
        }

        .dashboard-chat-list {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--light);
            min-height: 320px;
            max-height: 460px;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dashboard-chat-message {
            max-width: 82%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            background: var(--white);
        }

        .dashboard-chat-message.mine {
            margin-left: auto;
            border-color: var(--primary);
        }

        .dashboard-chat-message.admin {
            margin-right: auto;
        }

        .dashboard-chat-meta {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            color: var(--gray);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .dashboard-chat-text {
            color: var(--dark);
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .dashboard-chat-empty {
            color: var(--gray);
            text-align: center;
            border: 1px dashed var(--border);
            border-radius: 10px;
            background: var(--white);
            padding: 20px;
        }

        .dashboard-chat-form {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
        }

        .dashboard-tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 999px;
            background: var(--danger);
            color: var(--white);
            font-size: 12px;
            font-weight: 700;
            margin-left: 6px;
        }

        @media (max-width: 700px) {
            .dashboard-chat-layout {
                grid-template-columns: 1fr;
            }

            .dashboard-chat-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo"><i class="fas fa-briefcase"></i><span>JobVermittlung</span></div>
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="window.location.href='index.html'">Startseite</button>
                    <button class="btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-top">
                <div>
                    <h1 id="welcome">Dashboard</h1>
                    <p id="subtitle" style="color: var(--gray);"></p>
                </div>
                <div class="badge" id="userBadge">Laden...</div>
            </div>

            <div class="panel-grid">
                <div class="panel">
                    <div style="color: var(--gray);">Meine Jobs</div>
                    <div class="value" id="countJobs">0</div>
                </div>
                <div class="panel">
                    <div style="color: var(--gray);">Meine Bewerbungen</div>
                    <div class="value" id="countBewerbungen">0</div>
                </div>
                <div class="panel">
                    <div style="color: var(--gray);">Gespeicherte Jobs</div>
                    <div class="value" id="countFavoriten">0</div>
                </div>
            </div>

            <section class="card" id="arbeitgeberActions" style="display:none;">
                <h2 style="margin-bottom: 10px;">Job erstellen</h2>
                <form id="jobForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="titel">Titel</label>
                            <input class="form-input" id="titel" required />
                        </div>
                        <div class="form-group">
                            <label for="firma">Firma</label>
                            <input class="form-input" id="firma" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="standort">Standort</label>
                            <input class="form-input" id="standort" required />
                        </div>
                        <div class="form-group">
                            <label for="jobTyp">Beschäftigungsart</label>
                            <select class="form-input" id="jobTyp" required>
                                <option>Vollzeit</option>
                                <option>Teilzeit</option>
                                <option>Freelance</option>
                                <option>Remote</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="kategorie">Kategorie</label>
                            <input class="form-input" id="kategorie" placeholder="IT & Software" />
                        </div>
                        <div class="form-group">
                            <label for="branche">Branche</label>
                            <input class="form-input" id="branche" placeholder="Technologie" />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="gehaltVon">Gehalt von (€)</label>
                            <input class="form-input" id="gehaltVon" type="number" min="0" />
                        </div>
                        <div class="form-group">
                            <label for="gehaltBis">Gehalt bis (€)</label>
                            <input class="form-input" id="gehaltBis" type="number" min="0" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="erfahrung">Erfahrung</label>
                        <input class="form-input" id="erfahrung" placeholder="2-4 Jahre" />
                    </div>
                    <div class="form-group">
                        <label for="beschreibung">Beschreibung</label>
                        <textarea class="form-input" id="beschreibung" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="anforderungen">Anforderungen</label>
                        <textarea class="form-input" id="anforderungen" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="benefits">Benefits</label>
                        <textarea class="form-input" id="benefits" rows="3"></textarea>
                    </div>
                    <button class="btn-success" type="submit"><i class="fas fa-plus"></i> Job veröffentlichen</button>
                </form>
            </section>

            <section class="card">
                <div style="display:flex; gap:10px; margin-bottom: 12px;">
                    <button class="btn-primary" id="tabMainBtn" type="button" onclick="switchDashboardTab('main')">Übersicht</button>
                    <button class="btn-secondary" id="tabTasksBtn" type="button" onclick="switchDashboardTab('tasks')">Aufgaben</button>
                    <button class="btn-secondary" id="tabMessagesBtn" type="button" onclick="switchDashboardTab('messages')">Nachrichten<span id="messagesUnreadBadge" class="dashboard-tab-badge" style="display:none;">0</span></button>
                </div>

                <div id="mainTabPane">
                    <h2 style="margin-bottom: 10px;" id="listTitle">Meine Jobs</h2>
                    <div id="listContainer">Lade Daten...</div>
                </div>

                <div id="tasksTabPane" style="display:none;">
                    <h2 style="margin-bottom: 10px;">Meine Aufgaben</h2>
                    <div id="tasksContainer">Lade Aufgaben...</div>
                </div>

                <div id="messagesTabPane" style="display:none;">
                    <h2 style="margin-bottom: 10px;">Nachrichten mit Admin</h2>
                    <div class="dashboard-chat-layout">
                        <aside>
                            <div style="font-weight: 700; margin-bottom: 8px;">Verlauf</div>
                            <div id="dashboardConversationList" class="dashboard-conversation-list">
                                <div class="dashboard-chat-empty">Lade Verlauf...</div>
                            </div>
                        </aside>

                        <div>
                            <div class="dashboard-chat-toolbar">
                                <div class="dashboard-chat-status">
                                    <span class="badge" id="messagesStatusBadge">Lade...</span>
                                    <span id="messagesStatusText">Verbindung wird vorbereitet...</span>
                                </div>
                                <button class="btn-secondary" type="button" id="newConversationBtn">Neues Gespräch starten</button>
                            </div>
                            <div id="dashboardMessageList" class="dashboard-chat-list">
                                <div class="dashboard-chat-empty">Lade Nachrichten...</div>
                            </div>
                            <form id="dashboardMessageForm" class="dashboard-chat-form">
                                <input class="form-input" id="dashboardMessageInput" type="text" maxlength="1200" placeholder="Nachricht an Admin schreiben..." />
                                <button class="btn-primary" type="submit">Senden</button>
                            </form>
                        </div>
                    </div>
                </div>

            </section>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        let currentUser = null;
        let dashboardChatPollHandle = null;
        let dashboardUnreadPollHandle = null;
        let activeDashboardConversationId = '';
        let activeDashboardConversationMeta = null;
        let activeDashboardMessages = [];
        let latestDashboardConversations = [];
        let currentDashboardTab = 'main';
        let hasInitializedUnreadState = false;
        let lastUnreadCount = 0;
        const DASHBOARD_CHAT_POLL_INTERVAL_MS = 7000;
        const DASHBOARD_UNREAD_POLL_INTERVAL_MS = 10000;
        const DASHBOARD_CHAT_SEEN_STORAGE_KEY = 'jc_dashboard_chat_seen_v1';
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL)
            ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '')
            : '';

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Fehler');
            return data;
        }

        function loadSeenConversationsMap() {
            try {
                const raw = localStorage.getItem(DASHBOARD_CHAT_SEEN_STORAGE_KEY);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch {
                return {};
            }
        }

        function saveSeenConversationsMap(mapValue) {
            localStorage.setItem(DASHBOARD_CHAT_SEEN_STORAGE_KEY, JSON.stringify(mapValue || {}));
        }

        function playNotificationTone() {
            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) return;

                const audioContext = new AudioContextClass();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.001, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.12, audioContext.currentTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.18);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
                oscillator.onended = () => {
                    audioContext.close().catch(() => {});
                };
            } catch {
                // Ton ist optional
            }
        }

        async function requestBrowserNotificationPermission() {
            if (!('Notification' in window)) return 'unsupported';
            if (Notification.permission === 'granted') return 'granted';
            if (Notification.permission === 'denied') return 'denied';

            try {
                const result = await Notification.requestPermission();
                return result;
            } catch {
                return 'denied';
            }
        }

        function showBrowserNotification(unreadCount) {
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;

            try {
                const title = unreadCount > 1
                    ? `${unreadCount} neue Admin-Nachrichten`
                    : 'Neue Admin-Nachricht';
                const notification = new Notification(title, {
                    body: 'Öffne das Dashboard und gehe zu „Nachrichten“.',
                    tag: 'jobvermittlung-dashboard-chat',
                    renotify: true
                });

                notification.onclick = () => {
                    window.focus();
                    switchDashboardTab('messages');
                    notification.close();
                };
            } catch {
                // Browser-Hinweis ist optional
            }
        }

        function updateMessagesUnreadBadge(count) {
            const badge = document.getElementById('messagesUnreadBadge');
            if (!badge) return;
            const safeCount = Number.isFinite(Number(count)) ? Math.max(0, Number(count)) : 0;
            badge.style.display = safeCount > 0 ? 'inline-flex' : 'none';
            badge.textContent = safeCount > 99 ? '99+' : String(safeCount);
        }

        function handleUnreadNotifications(unreadCount) {
            const safeUnreadCount = Number.isFinite(Number(unreadCount)) ? Math.max(0, Number(unreadCount)) : 0;

            if (!hasInitializedUnreadState) {
                hasInitializedUnreadState = true;
                lastUnreadCount = safeUnreadCount;
                return;
            }

            const hasNewUnread = safeUnreadCount > lastUnreadCount;
            lastUnreadCount = safeUnreadCount;

            if (!hasNewUnread || currentDashboardTab === 'messages') {
                return;
            }

            playNotificationTone();

            if (document.visibilityState === 'hidden') {
                showBrowserNotification(safeUnreadCount);
            }
        }

        function getUnreadConversationsCount(conversations) {
            const seenMap = loadSeenConversationsMap();
            return (conversations || []).reduce((count, conversation) => {
                const conversationId = String(conversation.conversation_id || '');
                const hasAdminLatest = Boolean(conversation.letzte_nachricht_von_admin);
                const latestAt = String(conversation.letzte_nachricht_am || '');
                if (!conversationId || !hasAdminLatest || !latestAt) {
                    return count;
                }

                const seenAt = String(seenMap[conversationId] || '');
                const latestDate = new Date(latestAt);
                const seenDate = new Date(seenAt);
                const isLatestDateValid = !Number.isNaN(latestDate.getTime());
                const isSeenDateValid = !Number.isNaN(seenDate.getTime());

                if (!isLatestDateValid) {
                    return count;
                }

                if (!isSeenDateValid || latestDate > seenDate) {
                    return count + 1;
                }

                return count;
            }, 0);
        }

        function markConversationsAsSeen(conversations) {
            const seenMap = loadSeenConversationsMap();
            let hasChanges = false;

            for (const conversation of (conversations || [])) {
                const conversationId = String(conversation.conversation_id || '');
                const latestAt = String(conversation.letzte_nachricht_am || '');
                if (!conversationId || !latestAt) {
                    continue;
                }

                if (!seenMap[conversationId] || new Date(latestAt) > new Date(String(seenMap[conversationId] || ''))) {
                    seenMap[conversationId] = latestAt;
                    hasChanges = true;
                }
            }

            if (hasChanges) {
                saveSeenConversationsMap(seenMap);
            }
        }

        function formatConversationPreview(conversation) {
            const hasAdminLatest = Boolean(conversation && conversation.letzte_nachricht_von_admin);
            const sender = hasAdminLatest
                ? (conversation.letzte_admin_anzeige_name || 'Admin')
                : 'Sie';
            const text = String((conversation && conversation.letzte_nachricht) || '').trim();
            if (!text) {
                return 'Noch keine Nachrichten';
            }
            return `${sender}: ${text}`;
        }

        function renderDashboardConversationList() {
            const container = document.getElementById('dashboardConversationList');
            if (!container) return;

            const conversations = latestDashboardConversations || [];
            if (!conversations.length) {
                container.innerHTML = '<div class="dashboard-chat-empty">Noch kein Verlauf vorhanden.</div>';
                return;
            }

            container.innerHTML = conversations.map((conversation) => {
                const conversationId = String(conversation.conversation_id || '');
                const isActive = conversationId === String(activeDashboardConversationId || '');
                const statusInfo = formatConversationStatus(conversation.conversation_status || 'offen');
                return `
                    <button type="button" class="dashboard-conversation-item ${isActive ? 'active' : ''}" onclick="selectDashboardConversation('${escapeHtml(conversationId)}')">
                        <div class="dashboard-conversation-meta">
                            <strong>${escapeHtml(statusInfo.label)}</strong>
                            <span>${escapeHtml(formatDateTime(conversation.letzte_nachricht_am))}</span>
                        </div>
                        <div class="dashboard-conversation-preview">${escapeHtml(formatConversationPreview(conversation))}</div>
                    </button>
                `;
            }).join('');
        }

        async function selectDashboardConversation(conversationId) {
            activeDashboardConversationId = String(conversationId || '');
            await loadDashboardMessages();
            renderDashboardConversationList();
        }

        window.selectDashboardConversation = selectDashboardConversation;

        async function refreshMessagesUnreadBadge() {
            const result = await api('/api/chat/conversations');
            const conversations = Array.isArray(result.conversations)
                ? result.conversations.filter((item) => !item.conversation_deleted)
                : [];

            latestDashboardConversations = conversations;
            renderDashboardConversationList();

            if (currentDashboardTab === 'messages') {
                markConversationsAsSeen(conversations);
                updateMessagesUnreadBadge(0);
                return;
            }

            const unreadCount = getUnreadConversationsCount(conversations);
            updateMessagesUnreadBadge(unreadCount);
            handleUnreadNotifications(unreadCount);
        }

        async function loadCurrentUser() {
            const session = await api('/api/check-session');
            if (!session.isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = await api('/api/user');
            const normalizedUserType = String(currentUser.user_typ || '').trim().toLowerCase();
            const isArbeitgeber = normalizedUserType === 'arbeitgeber';

            if (normalizedUserType === 'admin') {
                window.location.href = 'admin.html';
                return;
            }

            document.getElementById('welcome').textContent = `Hallo, ${currentUser.vorname}!`;

            document.getElementById('subtitle').textContent = isArbeitgeber
                ? 'Verwalten Sie Ihre Stellen und Bewerbungsprozesse.'
                : 'Entdecken Sie passende Stellen und verfolgen Sie Ihren Vermittlungsstatus.';
            document.getElementById('userBadge').textContent = isArbeitgeber
                ? 'Arbeitgeber'
                : (normalizedUserType === 'admin' ? 'Admin' : 'Bewerber');

            if (isArbeitgeber) {
                document.getElementById('arbeitgeberActions').style.display = 'block';
                document.getElementById('listTitle').textContent = 'Meine veröffentlichten Jobs';
            } else {
                document.getElementById('listTitle').textContent = 'Meine Bewerbungen';
            }
        }

        async function loadData() {
            if (!currentUser) return;

            if (currentUser.user_typ === 'arbeitgeber') {
                const jobsRes = await api('/api/my-jobs');
                document.getElementById('countJobs').textContent = jobsRes.jobs.length;
                const list = jobsRes.jobs;
                document.getElementById('listContainer').innerHTML = list.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Standort</th>
                                <th>Typ</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(job => `
                                <tr>
                                    <td>${escapeHtml(job.titel)}</td>
                                    <td>${escapeHtml(job.standort)}</td>
                                    <td>${escapeHtml(job.job_typ)}</td>
                                    <td><span class="badge ${job.status === 'aktiv' ? 'success' : 'warning'}">${escapeHtml(job.status)}</span></td>
                                    <td>
                                        <button class="btn-secondary" onclick="openJob(${job.id})">Ansehen</button>
                                        <button class="btn-danger" onclick="deleteJob(${job.id})">Löschen</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Sie haben noch keine Jobs veröffentlicht.</p>';

                document.getElementById('countBewerbungen').textContent = '—';
                document.getElementById('countFavoriten').textContent = '—';
            } else {
                const bew = await api('/api/my-bewerbungen');
                const fav = await api('/api/favoriten');
                document.getElementById('countJobs').textContent = '—';
                document.getElementById('countBewerbungen').textContent = bew.bewerbungen.length;
                document.getElementById('countFavoriten').textContent = fav.favoriten.length;

                document.getElementById('listContainer').innerHTML = bew.bewerbungen.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Job</th>
                                <th>Firma</th>
                                <th>Standort</th>
                                <th>Status</th>
                                <th>Datum</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bew.bewerbungen.map(item => `
                                <tr>
                                    <td>${escapeHtml(item.titel)}</td>
                                    <td>${escapeHtml(item.firma)}</td>
                                    <td>${escapeHtml(item.standort)}</td>
                                    <td><span class="badge">${escapeHtml(item.status)}</span></td>
                                    <td>${new Date(item.erstellt_am).toLocaleDateString('de-DE')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Sie haben noch keine Bewerbungen gesendet.</p>';
            }
        }

        async function loadTasks() {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = 'Lade Aufgaben...';

            try {
                const taskRes = await api('/api/tasks');
                const tasks = taskRes.tasks || [];

                container.innerHTML = tasks.length ? `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Titel</th>
                                <th>Beschreibung</th>
                                <th>Status</th>
                                <th>Fällig</th>
                                <th>Admin</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks.map(task => `
                                <tr>
                                    <td>${escapeHtml(task.titel || '—')}</td>
                                    <td>${escapeHtml(task.beschreibung || '—')}</td>
                                    <td><span class="badge ${task.status === 'erledigt' ? 'success' : 'warning'}">${escapeHtml(task.status || 'offen')}</span></td>
                                    <td>${task.faellig_am ? new Date(task.faellig_am).toLocaleDateString('de-DE') : '—'}</td>
                                    <td>${escapeHtml(task.admin_anzeige_name || `${task.admin_vorname || ''} ${task.admin_nachname || ''}`.trim() || task.admin_email || '—')}</td>
                                    <td>
                                        ${task.status !== 'erledigt'
                                            ? `<button class="btn-success" onclick="markTaskDone(${task.id})">Erledigt</button>`
                                            : '<span style="color: var(--success); font-weight:600;">✓</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>Keine Aufgaben zugewiesen.</p>';
            } catch (error) {
                container.innerHTML = '<p>Fehler beim Laden der Aufgaben.</p>';
            }
        }

        function getCurrentUserChatIdentity() {
            if (!currentUser) return null;
            const vorname = String(currentUser.vorname || '').trim();
            const nachname = String(currentUser.nachname || '').trim();
            const email = String(currentUser.email || '').trim().toLowerCase();
            if (!vorname || !nachname || !email) {
                return null;
            }
            return { vorname, nachname, email };
        }

        function formatDateTime(value) {
            if (!value) return '—';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '—';
            return date.toLocaleString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatConversationStatus(status) {
            const normalized = String(status || 'offen').trim().toLowerCase();
            if (normalized === 'in_bearbeitung') return { key: 'warning', label: 'In Bearbeitung', text: 'Admin bearbeitet Ihre Anfrage.' };
            if (normalized === 'erledigt') return { key: 'success', label: 'Erledigt', text: 'Gespräch wurde als erledigt markiert.' };
            if (normalized === 'geschlossen') return { key: 'danger', label: 'Geschlossen', text: 'Gespräch wurde geschlossen.' };
            return { key: '', label: 'Offen', text: 'Sie können direkt an das Adminpanel schreiben.' };
        }

        function isConversationLocked() {
            if (!activeDashboardConversationMeta) return false;
            const normalized = String(activeDashboardConversationMeta.conversation_status || 'offen').trim().toLowerCase();
            return Boolean(activeDashboardConversationMeta.conversation_deleted) || ['geschlossen', 'erledigt'].includes(normalized);
        }

        function renderDashboardMessages() {
            const list = document.getElementById('dashboardMessageList');
            const statusBadge = document.getElementById('messagesStatusBadge');
            const statusText = document.getElementById('messagesStatusText');
            const input = document.getElementById('dashboardMessageInput');
            const submitButton = document.querySelector('#dashboardMessageForm button[type="submit"]');

            const statusInfo = formatConversationStatus(activeDashboardConversationMeta?.conversation_status || 'offen');
            statusBadge.textContent = statusInfo.label;
            statusBadge.className = statusInfo.key ? `badge ${statusInfo.key}` : 'badge';
            statusText.textContent = statusInfo.text;

            const locked = isConversationLocked();
            input.disabled = locked;
            submitButton.disabled = locked;
            input.placeholder = locked
                ? 'Konversation ist geschlossen/erledigt. Bitte neues Gespräch starten.'
                : 'Nachricht an Admin schreiben...';

            if (!activeDashboardConversationId) {
                list.innerHTML = '<div class="dashboard-chat-empty">Noch kein Gespräch vorhanden. Starten Sie ein neues Gespräch.</div>';
                return;
            }

            if (!activeDashboardMessages.length) {
                list.innerHTML = '<div class="dashboard-chat-empty">Noch keine Nachrichten vorhanden.</div>';
                return;
            }

            const currentUserFullName = `${currentUser?.vorname || ''} ${currentUser?.nachname || ''}`.trim() || 'Sie';

            list.innerHTML = activeDashboardMessages.map((message) => {
                const isAdmin = Boolean(message.admin_id);
                const bubbleClass = isAdmin ? 'dashboard-chat-message admin' : 'dashboard-chat-message mine';
                const sender = isAdmin
                    ? (message.admin_anzeige_name || 'Admin')
                    : (message.visitor_vorname && message.visitor_nachname
                        ? `${message.visitor_vorname} ${message.visitor_nachname}`
                        : currentUserFullName);

                return `
                    <div class="${bubbleClass}">
                        <div class="dashboard-chat-meta">
                            <strong>${escapeHtml(sender)}</strong>
                            <span>${escapeHtml(formatDateTime(message.erstellt_am))}</span>
                        </div>
                        <div class="dashboard-chat-text">${escapeHtml(message.nachricht || '')}</div>
                    </div>
                `;
            }).join('');

            list.scrollTop = list.scrollHeight;
        }

        async function createNewDashboardConversation() {
            const identity = getCurrentUserChatIdentity();
            if (!identity) {
                throw new Error('Profildaten für den Chat fehlen. Bitte Profil prüfen.');
            }

            const result = await api('/api/chat/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(identity)
            });

            activeDashboardConversationId = String(result.conversationId || '');
            activeDashboardConversationMeta = null;
            activeDashboardMessages = [];
            renderDashboardMessages();
            renderDashboardConversationList();
        }

        async function loadDashboardConversations() {
            const result = await api('/api/chat/conversations');
            const conversations = Array.isArray(result.conversations) ? result.conversations : [];
            const availableConversations = conversations.filter((item) => !item.conversation_deleted);
            latestDashboardConversations = availableConversations;

            if (!activeDashboardConversationId || !availableConversations.some((item) => String(item.conversation_id) === String(activeDashboardConversationId))) {
                activeDashboardConversationId = availableConversations.length
                    ? String(availableConversations[0].conversation_id)
                    : '';
            }

            if (!activeDashboardConversationId && getCurrentUserChatIdentity()) {
                await createNewDashboardConversation();
            }

            if (currentDashboardTab === 'messages') {
                markConversationsAsSeen(availableConversations);
                updateMessagesUnreadBadge(0);
            }

            renderDashboardConversationList();
        }

        async function loadDashboardMessages() {
            if (!activeDashboardConversationId) {
                activeDashboardMessages = [];
                activeDashboardConversationMeta = null;
                renderDashboardMessages();
                return;
            }

            const result = await api(`/api/chat/messages?conversationId=${encodeURIComponent(activeDashboardConversationId)}`);
            activeDashboardMessages = Array.isArray(result.messages) ? result.messages : [];
            activeDashboardConversationMeta = result.conversation || null;
            renderDashboardMessages();
        }

        async function refreshDashboardMessages() {
            await loadDashboardConversations();
            await loadDashboardMessages();
        }

        function stopDashboardChatPolling() {
            if (dashboardChatPollHandle) {
                clearInterval(dashboardChatPollHandle);
                dashboardChatPollHandle = null;
            }
        }

        function startDashboardChatPolling() {
            stopDashboardChatPolling();
            dashboardChatPollHandle = setInterval(async () => {
                try {
                    await refreshDashboardMessages();
                } catch {
                    // Polling-Fehler werden bei nächstem Intervall erneut versucht
                }
            }, DASHBOARD_CHAT_POLL_INTERVAL_MS);
        }

        function stopDashboardUnreadPolling() {
            if (dashboardUnreadPollHandle) {
                clearInterval(dashboardUnreadPollHandle);
                dashboardUnreadPollHandle = null;
            }
        }

        function startDashboardUnreadPolling() {
            stopDashboardUnreadPolling();
            dashboardUnreadPollHandle = setInterval(async () => {
                try {
                    await refreshMessagesUnreadBadge();
                } catch {
                    // Fehler beim Badge-Polling werden automatisch erneut versucht
                }
            }, DASHBOARD_UNREAD_POLL_INTERVAL_MS);
        }

        function bindDashboardMessageEvents() {
            document.getElementById('dashboardMessageForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const input = document.getElementById('dashboardMessageInput');
                const text = String(input.value || '').trim();
                if (!text) return;

                if (!activeDashboardConversationId) {
                    await createNewDashboardConversation();
                }

                try {
                    await api('/api/chat/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversationId: activeDashboardConversationId,
                            nachricht: text
                        })
                    });

                    input.value = '';
                    await refreshDashboardMessages();
                } catch (error) {
                    alert(error.message || 'Nachricht konnte nicht gesendet werden.');
                }
            });

            document.getElementById('newConversationBtn').addEventListener('click', async () => {
                try {
                    await createNewDashboardConversation();
                    await refreshDashboardMessages();
                } catch (error) {
                    alert(error.message || 'Neues Gespräch konnte nicht gestartet werden.');
                }
            });

            document.getElementById('tabMessagesBtn').addEventListener('click', () => {
                requestBrowserNotificationPermission().catch(() => {});
            });
        }

        async function markTaskDone(taskId) {
            try {
                await api(`/api/tasks/${taskId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'erledigt' })
                });
                await loadTasks();
            } catch (error) {
                alert(error.message || 'Aufgabe konnte nicht aktualisiert werden.');
            }
        }

        function switchDashboardTab(tab) {
            currentDashboardTab = tab;
            const mainPane = document.getElementById('mainTabPane');
            const taskPane = document.getElementById('tasksTabPane');
            const messagesPane = document.getElementById('messagesTabPane');
            const mainBtn = document.getElementById('tabMainBtn');
            const tasksBtn = document.getElementById('tabTasksBtn');
            const messagesBtn = document.getElementById('tabMessagesBtn');

            if (tab === 'tasks') {
                mainPane.style.display = 'none';
                taskPane.style.display = 'block';
                messagesPane.style.display = 'none';
                mainBtn.className = 'btn-secondary';
                tasksBtn.className = 'btn-primary';
                messagesBtn.className = 'btn-secondary';
                stopDashboardChatPolling();
            } else if (tab === 'messages') {
                mainPane.style.display = 'none';
                taskPane.style.display = 'none';
                messagesPane.style.display = 'block';
                mainBtn.className = 'btn-secondary';
                tasksBtn.className = 'btn-secondary';
                messagesBtn.className = 'btn-primary';
                refreshDashboardMessages().catch(() => {
                    document.getElementById('dashboardMessageList').innerHTML = '<div class="dashboard-chat-empty">Nachrichten konnten nicht geladen werden.</div>';
                });
                startDashboardChatPolling();
                markConversationsAsSeen(latestDashboardConversations);
                updateMessagesUnreadBadge(0);
            } else {
                mainPane.style.display = 'block';
                taskPane.style.display = 'none';
                messagesPane.style.display = 'none';
                mainBtn.className = 'btn-primary';
                tasksBtn.className = 'btn-secondary';
                messagesBtn.className = 'btn-secondary';
                stopDashboardChatPolling();
            }
        }

        function getInitialDashboardTab() {
            const params = new URLSearchParams(window.location.search);
            const tab = String(params.get('tab') || '').trim().toLowerCase();
            if (tab === 'tasks' || tab === 'messages') {
                return tab;
            }
            return 'main';
        }

        async function deleteJob(id) {
            if (!confirm('Job wirklich löschen?')) return;
            try {
                await api(`/api/jobs/${id}`, { method: 'DELETE' });
                await loadData();
            } catch (err) {
                alert(err.message);
            }
        }

        function openJob(id) {
            window.location.href = `job-details.html?id=${id}`;
        }

        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                titel: document.getElementById('titel').value,
                firma: document.getElementById('firma').value,
                standort: document.getElementById('standort').value,
                jobTyp: document.getElementById('jobTyp').value,
                kategorie: document.getElementById('kategorie').value,
                branche: document.getElementById('branche').value,
                gehaltVon: document.getElementById('gehaltVon').value || null,
                gehaltBis: document.getElementById('gehaltBis').value || null,
                erfahrung: document.getElementById('erfahrung').value,
                beschreibung: document.getElementById('beschreibung').value,
                anforderungen: document.getElementById('anforderungen').value,
                benefits: document.getElementById('benefits').value
            };

            try {
                await api('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                e.target.reset();
                await loadData();
                alert('Stelle erfolgreich veröffentlicht.');
            } catch (err) {
                alert(err.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await api('/api/logout', { method: 'POST' });
            window.location.href = 'index.html';
        });

        bindDashboardMessageEvents();

        (async () => {
            try {
                await loadCurrentUser();
                await loadData();
                await loadTasks();
                await refreshMessagesUnreadBadge();
                startDashboardUnreadPolling();
                switchDashboardTab(getInitialDashboardTab());
            } catch (err) {
                alert(err.message);
            }
        })();
    </script>
    <script src="chat-widget.js"></script>
</body>
</html>
