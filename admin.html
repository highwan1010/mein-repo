<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - JobVermittlung</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .chat-admin-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 16px;
            min-height: 680px;
        }

        .chat-admin-sidebar {
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px;
            overflow-y: auto;
            max-height: 760px;
            background: var(--white);
        }

        .chat-thread-item {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--white);
            text-align: left;
            padding: 11px;
            margin-bottom: 9px;
            cursor: pointer;
            transition: border-color .16s ease, box-shadow .16s ease, transform .16s ease;
        }

        .chat-thread-item:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .chat-thread-item.active {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .chat-thread-top {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .chat-thread-top small,
        .chat-thread-meta,
        .chat-thread-preview {
            color: var(--gray);
            font-size: 12px;
        }

        .chat-thread-preview {
            margin-top: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            white-space: normal;
        }

        .chat-admin-main {
            border: 1px solid var(--border);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            min-height: 680px;
            background: var(--white);
            overflow: hidden;
        }

        .chat-admin-header {
            border-bottom: 1px solid var(--border);
            padding: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            background: var(--light);
        }

        .chat-live-panel {
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, var(--light), var(--white));
            padding: 10px 12px 12px;
            display: grid;
            gap: 10px;
        }

        .chat-live-panel-title {
            font-size: 12px;
            font-weight: 800;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .chat-admin-controls {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 8px;
            align-items: center;
            background: var(--white);
        }

        .chat-admin-name-row {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            display: grid;
            gap: 8px;
            background: var(--white);
        }

        .chat-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            color: var(--gray);
            background: var(--white);
        }

        .chat-status-badge.offen { border-color: var(--border); color: var(--gray); }
        .chat-status-badge.in_bearbeitung { border-color: var(--accent); color: var(--accent); }
        .chat-status-badge.erledigt { border-color: var(--success); color: var(--success); }
        .chat-status-badge.geschlossen { border-color: var(--danger); color: var(--danger); }

        .chat-admin-header small { color: var(--gray); }

        .chat-admin-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 11px;
            background: #f1f5f9;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .chat-message {
            max-width: 78%;
            padding: 11px;
            border-radius: 13px;
            border: 1px solid var(--border);
            background: var(--white);
            box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
        }

        .chat-message-admin {
            margin-left: auto;
            background: var(--white);
            border-color: var(--primary);
        }

        .chat-message-visitor {
            margin-right: auto;
            background: var(--white);
        }

        .chat-message-head {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 2px;
            color: var(--gray);
            font-size: 12px;
        }

        .chat-message-text {
            color: var(--dark);
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .chat-message-actions {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
        }

        .chat-admin-form {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            background: var(--white);
        }

        .chat-admin-layout.scope-messages .chat-admin-sidebar {
            background: var(--light);
            border-color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-thread-item:hover,
        .chat-admin-layout.scope-messages .chat-thread-item.active {
            border-color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-admin-main {
            border-color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-admin-header {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: var(--white);
            border-bottom-color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-admin-header small {
            color: var(--white);
            opacity: 0.9;
        }

        .chat-admin-layout.scope-messages .chat-live-panel {
            background: linear-gradient(180deg, var(--white), var(--light));
        }

        .chat-admin-layout.scope-messages .chat-live-panel-title {
            color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-admin-controls,
        .chat-admin-layout.scope-messages .chat-admin-name-row {
            border-color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-admin-messages {
            background: var(--light);
        }

        .chat-admin-layout.scope-messages .chat-message-admin {
            border-color: var(--secondary);
        }

        .chat-admin-layout.scope-messages .chat-admin-form {
            border-top: 1px solid var(--secondary);
        }

        .chat-empty {
            color: var(--gray);
            text-align: center;
            padding: 22px;
            border: 1px dashed var(--border);
            border-radius: 10px;
            background: var(--white);
        }

        @media (max-width: 980px) {
            .chat-admin-layout {
                grid-template-columns: 1fr;
            }

            .chat-admin-controls {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo"><i class="fas fa-shield-alt"></i><span>JobVermittlung Admin</span></div>
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="window.location.href='index.html'">Startseite</button>
                    <button class="btn-secondary" onclick="window.location.href='dashboard.html'">Dashboard</button>
                    <button class="btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-top">
                <div>
                    <h1 id="welcome">Admin Panel</h1>
                    <p id="subtitle" style="color: var(--gray);">Vollständige Systemeinsicht in Vermittlungsstellen, Bewerbungen, Nutzer und Aufgaben.</p>
                </div>
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                    <span class="badge" id="livePollingStatus">Live aktiv</span>
                    <button class="btn-primary" id="refreshBtn"><i class="fas fa-rotate"></i> Aktualisieren</button>
                </div>
            </div>

            <div class="card" style="margin-top: 16px;">
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-secondary admin-tab-btn" data-tab="statistik" type="button" onclick="switchAdminTab('statistik')">Statistik</button>
                    <button class="btn-primary admin-tab-btn" data-tab="jobs" type="button" onclick="switchAdminTab('jobs')">Jobs</button>
                    <button class="btn-secondary admin-tab-btn" data-tab="users" type="button" onclick="switchAdminTab('users')">Benutzer</button>
                    <button class="btn-secondary admin-tab-btn" data-tab="tasks" type="button" onclick="switchAdminTab('tasks')">Aufgaben</button>
                    <button class="btn-secondary admin-tab-btn" data-tab="appointments" type="button" onclick="switchAdminTab('appointments')">Termine</button>
                    <button class="btn-secondary admin-tab-btn" data-tab="livechats" type="button" onclick="switchAdminTab('livechats')">Livechat</button>
                    <button class="btn-secondary admin-tab-btn" data-tab="chats" type="button" onclick="switchAdminTab('chats')">Nachrichten</button>
                </div>
            </div>

            <section class="card admin-tab-section" data-tab="statistik" style="display:none;">
                <h2 style="margin-bottom: 10px;">Statistik</h2>
                <div class="panel-grid" style="margin-bottom: 0;">
                    <div class="panel"><div style="color: var(--gray);">Benutzer</div><div class="value" id="countUsers">0</div></div>
                    <div class="panel"><div style="color: var(--gray);">Jobs</div><div class="value" id="countJobs">0</div></div>
                    <div class="panel"><div style="color: var(--gray);">Bewerbungen</div><div class="value" id="countBewerbungen">0</div></div>
                    <div class="panel"><div style="color: var(--gray);">Favoriten</div><div class="value" id="countFavoriten">0</div></div>
                </div>
            </section>

            <section class="card admin-tab-section" data-tab="jobs">
                <h2 style="margin-bottom: 10px;">Neue Vermittlungsstelle erstellen</h2>
                <div id="jobCreateAlert"></div>
                <form id="createJobForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="jobTitel">Titel</label>
                            <input class="form-input" type="text" id="jobTitel" required />
                        </div>
                        <div class="form-group">
                            <label for="jobFirma">Firma</label>
                            <input class="form-input" type="text" id="jobFirma" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="jobStandort">Standort</label>
                            <input class="form-input" type="text" id="jobStandort" required />
                        </div>
                        <div class="form-group">
                            <label for="jobTyp">Beschäftigungsart</label>
                            <select class="form-input" id="jobTyp">
                                <option value="Vollzeit">Vollzeit</option>
                                <option value="Teilzeit">Teilzeit</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Remote">Remote</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="jobBeschreibung">Beschreibung</label>
                        <textarea class="form-input" id="jobBeschreibung" rows="4" required></textarea>
                    </div>
                    <button class="btn-primary" type="submit">
                        <i class="fas fa-plus"></i> Vermittlungsstelle erstellen
                    </button>
                </form>
            </section>

            <section class="card admin-tab-section" data-tab="users" style="display:none;">
                <h2 style="margin-bottom: 10px;">Benutzer</h2>
                <div id="userManageAlert"></div>
                <form id="createUserForm" style="margin-bottom: 16px;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="newUserVorname">Vorname</label>
                            <input class="form-input" id="newUserVorname" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="newUserNachname">Nachname</label>
                            <input class="form-input" id="newUserNachname" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="newUserEmail">E-Mail</label>
                            <input class="form-input" id="newUserEmail" type="email" required />
                        </div>
                        <div class="form-group">
                            <label for="newUserPasswort">Passwort</label>
                            <input class="form-input" id="newUserPasswort" type="password" minlength="6" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="newUserTyp">Typ</label>
                            <select class="form-input" id="newUserTyp">
                                <option value="bewerber">Bewerber</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newUserFirma">Firma (optional)</label>
                            <input class="form-input" id="newUserFirma" type="text" />
                        </div>
                    </div>
                    <button class="btn-primary" type="submit">
                        <i class="fas fa-user-plus"></i> Benutzer hinzufügen
                    </button>
                </form>
                <div id="usersTable">Lade Daten...</div>
            </section>

            <section class="card admin-tab-section" data-tab="jobs">
                <h2 style="margin-bottom: 10px;">Jobs</h2>
                <div id="jobsTable">Lade Daten...</div>
            </section>

            <section class="card admin-tab-section" data-tab="jobs">
                <h2 style="margin-bottom: 10px;">Bewerbungen</h2>
                <div id="bewerbungenTable">Lade Daten...</div>
            </section>

            <section class="card admin-tab-section" data-tab="tasks" style="display:none;">
                <h2 style="margin-bottom: 10px;">Aufgaben zuteilen</h2>
                <div id="taskManageAlert"></div>
                <form id="assignTaskForm" style="margin-bottom: 16px;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="taskUserId">Bewerber</label>
                            <select class="form-input" id="taskUserId" required></select>
                        </div>
                        <div class="form-group">
                            <label for="taskTitel">Titel</label>
                            <input class="form-input" id="taskTitel" type="text" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="taskSenderName">Auftrag von (Name frei wählbar)</label>
                        <input class="form-input" id="taskSenderName" type="text" maxlength="140" placeholder="z. B. Team Vermittlung" />
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="taskStatus">Status</label>
                            <select class="form-input" id="taskStatus" required>
                                <option value="offen">Offen</option>
                                <option value="in_bearbeitung">In Bearbeitung</option>
                                <option value="erledigt">Erledigt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskFaelligAm">Fällig am (optional)</label>
                            <input class="form-input" id="taskFaelligAm" type="date" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="taskBeschreibung">Beschreibung / Planung (optional)</label>
                        <textarea class="form-input" id="taskBeschreibung" rows="7" placeholder="Hier können Sie die Aufgabe ausführlich planen und beschreiben..."></textarea>
                    </div>
                    <button class="btn-primary" type="submit">
                        <i class="fas fa-list-check"></i> Aufgabe zuweisen
                    </button>
                </form>
                <div id="tasksTable">Lade Daten...</div>
            </section>

            <section class="card admin-tab-section" data-tab="appointments" style="display:none;">
                <h2 style="margin-bottom: 10px;">Gebuchte Bewerbungstermine</h2>
                <div id="appointmentsTable">Lade Daten...</div>
            </section>

            <section class="card admin-tab-section" data-tab="jobs">
                <h2 style="margin-bottom: 10px;">Favoriten</h2>
                <div id="favoritenTable">Lade Daten...</div>
            </section>

            <section class="card admin-tab-section" data-tab="chats" style="display:none;">
                <h2 style="margin-bottom: 10px;" id="chatSectionTitle">Nachrichten von Nutzern</h2>
                <div id="chatsTable">Lade Daten...</div>
            </section>
        </div>
    </main>

    <div class="modal" id="editModal">
        <div class="modal-card" style="max-width: 880px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 14px;">
                <h2 id="editModalTitle">Bearbeiten</h2>
                <button class="btn-secondary" type="button" id="closeEditModalBtn">Schließen</button>
            </div>

            <div id="editModalAlert"></div>

            <form id="editModalForm">
                <div id="userEditFields" style="display:none;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editUserVorname">Vorname</label>
                            <input class="form-input" id="editUserVorname" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editUserNachname">Nachname</label>
                            <input class="form-input" id="editUserNachname" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editUserEmail">E-Mail</label>
                            <input class="form-input" id="editUserEmail" type="email" required />
                        </div>
                        <div class="form-group">
                            <label for="editUserTyp">Typ</label>
                            <select class="form-input" id="editUserTyp" required>
                                <option value="bewerber">Bewerber</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editUserFirma">Firma (optional)</label>
                        <input class="form-input" id="editUserFirma" type="text" />
                    </div>
                </div>

                <div id="jobEditFields" style="display:none;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editJobTitel">Titel</label>
                            <input class="form-input" id="editJobTitel" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editJobFirma">Firma</label>
                            <input class="form-input" id="editJobFirma" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editJobStandort">Standort</label>
                            <input class="form-input" id="editJobStandort" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editJobTyp">Beschäftigungsart</label>
                            <input class="form-input" id="editJobTyp" type="text" />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editJobStatus">Status</label>
                            <select class="form-input" id="editJobStatus" required>
                                <option value="aktiv">Aktiv</option>
                                <option value="pausiert">Pausiert</option>
                                <option value="geschlossen">Geschlossen</option>
                            </select>
                        </div>
                        <div></div>
                    </div>
                    <div class="form-group">
                        <label for="editJobBeschreibung">Beschreibung</label>
                        <textarea class="form-input" id="editJobBeschreibung" rows="5"></textarea>
                    </div>
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                    <button class="btn-secondary" type="button" id="cancelEditBtn">Abbrechen</button>
                    <button class="btn-primary" type="submit">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL)
            ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '')
            : '';
        let adminUsers = [];
        let adminJobs = [];
        let adminAppointments = [];
        let adminLiveChatThreads = [];
        let adminMessageThreads = [];
        let activeChatScope = 'chats';
        const activeChatConversationIds = {
            livechats: '',
            chats: ''
        };
        let activeChatMessages = [];
        let activeChatConversationMeta = null;
        let editingChatMessageId = null;
        let adminChatPollHandle = null;
        let activeAdminTab = 'jobs';
        let currentLivePollState = '';
        const ADMIN_LAST_TAB_STORAGE_KEY = 'jc_admin_last_tab_v1';
        const ADMIN_CHAT_NAME_STORAGE_KEY = 'jc_admin_chat_display_name_v1';
        let adminChatDisplayName = localStorage.getItem(ADMIN_CHAT_NAME_STORAGE_KEY) || '';
        let editContext = null;

        function getChatScopeFromTab(tabName) {
            return String(tabName || '') === 'livechats' ? 'livechats' : 'chats';
        }

        function getChatThreadsByScope(scope) {
            return scope === 'livechats' ? adminLiveChatThreads : adminMessageThreads;
        }

        function getActiveChatConversationId() {
            return String(activeChatConversationIds[activeChatScope] || '');
        }

        function setActiveChatConversationId(conversationId) {
            activeChatConversationIds[activeChatScope] = String(conversationId || '');
        }

        function updateChatSectionHeading() {
            const heading = document.getElementById('chatSectionTitle');
            if (!heading) return;
            heading.textContent = activeChatScope === 'livechats'
                ? 'Livechat (Website-Widget)'
                : 'Nachrichten von Nutzern (Dashboard)';
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function formatDate(value) {
            if (!value) return '—';
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? '—' : date.toLocaleString('de-DE');
        }

        function formatTaskStatus(status) {
            const normalized = String(status || 'offen');
            if (normalized === 'erledigt') {
                return { label: 'Erledigt', className: 'success' };
            }
            if (normalized === 'in_bearbeitung') {
                return { label: 'In Bearbeitung', className: 'warning' };
            }
            return { label: 'Offen', className: '' };
        }

        function switchAdminTab(tabName) {
            activeAdminTab = String(tabName || 'jobs');
            if (activeAdminTab === 'livechats' || activeAdminTab === 'chats') {
                activeChatScope = getChatScopeFromTab(activeAdminTab);
                updateChatSectionHeading();
            }
            localStorage.setItem(ADMIN_LAST_TAB_STORAGE_KEY, activeAdminTab);

            const sections = document.querySelectorAll('.admin-tab-section');
            sections.forEach((section) => {
                const isChatSectionAlias = activeAdminTab === 'livechats' && section.dataset.tab === 'chats';
                section.style.display = (section.dataset.tab === activeAdminTab || isChatSectionAlias) ? '' : 'none';
            });

            const buttons = document.querySelectorAll('.admin-tab-btn');
            buttons.forEach((button) => {
                button.className = button.dataset.tab === tabName ? 'btn-primary admin-tab-btn' : 'btn-secondary admin-tab-btn';
            });

            if (tabName === 'appointments') {
                refreshAppointmentsDataOnly().catch(() => {
                    // ignore tab-switch refresh errors
                });
            }

            if (tabName === 'livechats' || tabName === 'chats') {
                const chatsTable = document.getElementById('chatsTable');
                if (chatsTable) {
                    chatsTable.innerHTML = renderChats();
                    bindChatReplyForm();
                }
            }
        }

        function getInitialAdminTab() {
            const params = new URLSearchParams(window.location.search);
            const fromQuery = String(params.get('tab') || '').trim().toLowerCase();
            const allowedTabs = new Set(['jobs', 'users', 'tasks', 'appointments', 'chats', 'livechats', 'statistik']);

            if (allowedTabs.has(fromQuery)) {
                return fromQuery;
            }

            const fromStorage = String(localStorage.getItem(ADMIN_LAST_TAB_STORAGE_KEY) || '').trim().toLowerCase();
            if (allowedTabs.has(fromStorage)) {
                return fromStorage;
            }

            return 'jobs';
        }

        function isUserInteractingWithControls() {
            const activeElement = document.activeElement;
            if (!activeElement) return false;

            const tagName = String(activeElement.tagName || '').toUpperCase();
            if (!['SELECT', 'INPUT', 'TEXTAREA'].includes(tagName)) {
                return false;
            }

            if (activeElement.id === 'chatReplyInput') {
                return true;
            }

            return true;
        }

        function updateLivePollingStatus(state) {
            const statusBadge = document.getElementById('livePollingStatus');
            if (!statusBadge) return;

            if (state === currentLivePollState) {
                return;
            }

            currentLivePollState = state;
            if (state === 'paused') {
                statusBadge.textContent = 'Live pausiert (Bearbeitung)';
                statusBadge.className = 'badge warning';
                return;
            }

            if (state === 'error') {
                statusBadge.textContent = 'Live Fehler';
                statusBadge.className = 'badge danger';
                return;
            }

            statusBadge.textContent = 'Live aktiv';
            statusBadge.className = 'badge success';
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Fehler');
            return data;
        }

        function getAdminMessageName(message) {
            return String(
                message?.admin_anzeige_name
                || `${message?.admin_vorname || ''} ${message?.admin_nachname || ''}`.trim()
                || message?.admin_email
                || adminChatDisplayName
                || 'Admin'
            );
        }

        function getVisitorMessageName(message) {
            return String(
                `${message?.visitor_vorname || message?.user_vorname || ''} ${message?.visitor_nachname || message?.user_nachname || ''}`.trim()
                || message?.visitor_email
                || message?.user_email
                || 'Besucher'
            );
        }

        function syncAdminDisplayNameFromInput() {
            const nameInput = document.getElementById('chatAdminDisplayName');
            if (!nameInput) {
                return adminChatDisplayName;
            }

            const typedName = String(nameInput.value || '').trim();
            adminChatDisplayName = typedName;
            localStorage.setItem(ADMIN_CHAT_NAME_STORAGE_KEY, adminChatDisplayName);
            return adminChatDisplayName;
        }

        function formatConversationStatus(status) {
            const normalized = String(status || 'offen').trim().toLowerCase();
            if (normalized === 'in_bearbeitung') {
                return { key: 'in_bearbeitung', label: 'In Bearbeitung' };
            }
            if (normalized === 'erledigt') {
                return { key: 'erledigt', label: 'Erledigt' };
            }
            if (normalized === 'geschlossen') {
                return { key: 'geschlossen', label: 'Geschlossen' };
            }

            return { key: 'offen', label: 'Offen' };
        }

        function showJobCreateAlert(message, type = 'error') {
            document.getElementById('jobCreateAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function showUserManageAlert(message, type = 'error') {
            document.getElementById('userManageAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function showTaskManageAlert(message, type = 'error') {
            document.getElementById('taskManageAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function populateTaskAssigneeOptions(users) {
            const select = document.getElementById('taskUserId');
            const bewerber = users.filter((user) => user.user_typ === 'bewerber');
            if (!bewerber.length) {
                select.innerHTML = '<option value="">Keine Bewerber verfügbar</option>';
                select.disabled = true;
                return;
            }

            select.disabled = false;
            select.innerHTML = bewerber.map((user) => {
                const fullName = `${user.vorname || ''} ${user.nachname || ''}`.trim();
                return `<option value="${user.id}">${escapeHtml(fullName || user.email)} (${escapeHtml(user.email)})</option>`;
            }).join('');
        }

        function renderUsers(users) {
            if (!users.length) return '<p>Keine Benutzer vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>E-Mail</th>
                            <th>Typ</th>
                            <th>Firma</th>
                            <th>Erstellt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map((user) => `
                            <tr>
                                <td>${user.id}</td>
                                <td>${escapeHtml(`${user.vorname || ''} ${user.nachname || ''}`.trim())}</td>
                                <td>${escapeHtml(user.email)}</td>
                                <td><span class="badge">${escapeHtml(user.user_typ)}</span></td>
                                <td>${escapeHtml(user.firma || '—')}</td>
                                <td>${formatDate(user.erstellt_am)}</td>
                                <td>
                                    <button class="btn-secondary" onclick="editUser(${user.id})">
                                        Bearbeiten
                                    </button>
                                    <button class="btn-danger" style="margin-left:8px;" onclick="deleteUser(${user.id})">
                                        Löschen
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editModalAlert').innerHTML = '';
            editContext = null;
        }

        function showEditModalAlert(message, type = 'error') {
            document.getElementById('editModalAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function editUser(id) {
            const user = adminUsers.find((item) => Number(item.id) === Number(id));
            if (!user) {
                showUserManageAlert('Benutzer nicht gefunden.');
                return;
            }

            editContext = { type: 'user', id: Number(id) };
            document.getElementById('editModalTitle').textContent = `Benutzer bearbeiten (#${id})`;
            document.getElementById('userEditFields').style.display = 'block';
            document.getElementById('jobEditFields').style.display = 'none';

            document.getElementById('editUserVorname').value = user.vorname || '';
            document.getElementById('editUserNachname').value = user.nachname || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserTyp').value = user.user_typ || 'bewerber';
            document.getElementById('editUserFirma').value = user.firma || '';

            openEditModal();
        }

        async function deleteUser(id) {
            const user = adminUsers.find((item) => Number(item.id) === Number(id));
            const email = user ? (user.email || `#${id}`) : `#${id}`;
            const confirmed = confirm(`Benutzer ${email} wirklich löschen?`);
            if (!confirmed) return;

            try {
                await api(`/api/admin/users/${id}`, { method: 'DELETE' });
                showUserManageAlert('Benutzer erfolgreich gelöscht.', 'success');
                await loadAdminData();
            } catch (error) {
                showUserManageAlert(error.message || 'Fehler beim Löschen des Benutzers.');
            }
        }

        function renderJobs(jobs) {
            if (!jobs.length) return '<p>Keine Jobs vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Titel</th>
                            <th>Firma</th>
                            <th>Standort</th>
                            <th>Status</th>
                            <th>Arbeitgeber</th>
                            <th>Erstellt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jobs.map((job) => `
                            <tr>
                                <td>${job.id}</td>
                                <td>${escapeHtml(job.titel)}</td>
                                <td>${escapeHtml(job.firma)}</td>
                                <td>${escapeHtml(job.standort)}</td>
                                <td><span class="badge ${job.status === 'aktiv' ? 'success' : 'warning'}">${escapeHtml(job.status || '—')}</span></td>
                                <td>${escapeHtml(`${job.arbeitgeber_vorname || ''} ${job.arbeitgeber_nachname || ''}`.trim() || job.arbeitgeber_email || '—')}</td>
                                <td>${formatDate(job.erstellt_am)}</td>
                                <td>
                                    <button class="btn-secondary" onclick="editJob(${job.id})">
                                        Bearbeiten
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function editJob(id) {
            const job = adminJobs.find((item) => Number(item.id) === Number(id));
            if (!job) {
                showJobCreateAlert('Job nicht gefunden.');
                return;
            }

            editContext = { type: 'job', id: Number(id) };
            document.getElementById('editModalTitle').textContent = `Job bearbeiten (#${id})`;
            document.getElementById('userEditFields').style.display = 'none';
            document.getElementById('jobEditFields').style.display = 'block';

            document.getElementById('editJobTitel').value = job.titel || '';
            document.getElementById('editJobFirma').value = job.firma || '';
            document.getElementById('editJobStandort').value = job.standort || '';
            document.getElementById('editJobTyp').value = job.job_typ || '';
            document.getElementById('editJobStatus').value = job.status || 'aktiv';
            document.getElementById('editJobBeschreibung').value = job.beschreibung || '';

            openEditModal();
        }

        async function saveEditModal(event) {
            event.preventDefault();
            if (!editContext) return;

            try {
                if (editContext.type === 'user') {
                    const userTyp = String(document.getElementById('editUserTyp').value).trim().toLowerCase();
                    if (!['bewerber', 'admin'].includes(userTyp)) {
                        showEditModalAlert('Ungültiger Benutzer-Typ.');
                        return;
                    }

                    await api(`/api/admin/users/${editContext.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vorname: document.getElementById('editUserVorname').value.trim(),
                            nachname: document.getElementById('editUserNachname').value.trim(),
                            email: document.getElementById('editUserEmail').value.trim(),
                            userTyp,
                            firma: document.getElementById('editUserFirma').value.trim() || null
                        })
                    });

                    showUserManageAlert('Benutzer erfolgreich aktualisiert.', 'success');
                }

                if (editContext.type === 'job') {
                    await api(`/api/admin/jobs/${editContext.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            titel: document.getElementById('editJobTitel').value.trim(),
                            firma: document.getElementById('editJobFirma').value.trim(),
                            standort: document.getElementById('editJobStandort').value.trim(),
                            jobTyp: document.getElementById('editJobTyp').value.trim(),
                            status: document.getElementById('editJobStatus').value,
                            beschreibung: document.getElementById('editJobBeschreibung').value.trim()
                        })
                    });

                    showJobCreateAlert('Vermittlungsstelle erfolgreich aktualisiert.', 'success');
                }

                await loadAdminData();
                closeEditModal();
            } catch (error) {
                showEditModalAlert(error.message || 'Speichern fehlgeschlagen.');
            }
        }

        function renderBewerbungen(bewerbungen) {
            if (!bewerbungen.length) return '<p>Keine Bewerbungen vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bewerber</th>
                            <th>Job</th>
                            <th>Firma</th>
                            <th>Status</th>
                            <th>Erstellt</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bewerbungen.map((bewerbung) => `
                            <tr>
                                <td>${bewerbung.id}</td>
                                <td>${escapeHtml(`${bewerbung.bewerber_vorname || ''} ${bewerbung.bewerber_nachname || ''}`.trim() || bewerbung.bewerber_email || '—')}</td>
                                <td>${escapeHtml(bewerbung.job_titel || '—')}</td>
                                <td>${escapeHtml(bewerbung.job_firma || '—')}</td>
                                <td><span class="badge">${escapeHtml(bewerbung.status || '—')}</span></td>
                                <td>${formatDate(bewerbung.erstellt_am)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderFavoriten(favoriten) {
            if (!favoriten.length) return '<p>Keine Favoriten vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Benutzer</th>
                            <th>Job</th>
                            <th>Firma</th>
                            <th>Gespeichert am</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${favoriten.map((favorit) => `
                            <tr>
                                <td>${favorit.id}</td>
                                <td>${escapeHtml(`${favorit.user_vorname || ''} ${favorit.user_nachname || ''}`.trim() || favorit.user_email || '—')}</td>
                                <td>${escapeHtml(favorit.job_titel || '—')}</td>
                                <td>${escapeHtml(favorit.job_firma || '—')}</td>
                                <td>${formatDate(favorit.erstellt_am || favorit.favorit_seit)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderTasks(tasks) {
            if (!tasks.length) return '<p>Keine Aufgaben vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bewerber</th>
                            <th>Titel</th>
                            <th>Beschreibung</th>
                            <th>Auftrag von</th>
                            <th>Status</th>
                            <th>Fällig</th>
                            <th>Erstellt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tasks.map((task) => {
                            const taskStatus = formatTaskStatus(task.status);
                            return `
                            <tr>
                                <td>${task.id}</td>
                                <td>${escapeHtml(`${task.user_vorname || ''} ${task.user_nachname || ''}`.trim() || task.user_email || '—')}</td>
                                <td>${escapeHtml(task.titel || '—')}</td>
                                <td style="max-width: 340px; white-space: pre-wrap;">${escapeHtml(task.beschreibung || '—')}</td>
                                <td>${escapeHtml(task.admin_anzeige_name || `${task.admin_vorname || ''} ${task.admin_nachname || ''}`.trim() || task.admin_email || '—')}</td>
                                <td><span class="badge ${taskStatus.className}">${taskStatus.label}</span></td>
                                <td>${formatDate(task.faellig_am)}</td>
                                <td>${formatDate(task.erstellt_am)}</td>
                                <td>
                                    <div style="display:flex; gap:8px; align-items:center; min-width: 250px;">
                                        <select class="form-input" id="adminTaskStatus-${task.id}" style="min-width: 145px;">
                                            <option value="offen" ${task.status === 'offen' ? 'selected' : ''}>Offen</option>
                                            <option value="in_bearbeitung" ${task.status === 'in_bearbeitung' ? 'selected' : ''}>In Bearbeitung</option>
                                            <option value="erledigt" ${task.status === 'erledigt' ? 'selected' : ''}>Erledigt</option>
                                        </select>
                                        <button class="btn-secondary" type="button" onclick="updateAdminTaskStatus(${task.id})">Speichern</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        async function updateAdminTaskStatus(taskId) {
            const statusSelect = document.getElementById(`adminTaskStatus-${taskId}`);
            if (!statusSelect) return;

            const status = String(statusSelect.value || '').trim();
            if (!status) return;

            try {
                await api(`/api/admin/tasks/${taskId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                showTaskManageAlert('Aufgabenstatus erfolgreich aktualisiert.', 'success');
                await loadAdminData();
            } catch (error) {
                showTaskManageAlert(error.message || 'Aufgabenstatus konnte nicht geändert werden.');
            }
        }

        function renderAppointments(termine) {
            if (!termine.length) return '<p>Keine Termine vorhanden.</p>';
            const sortedTermine = [...termine].sort((left, right) => {
                const leftTime = new Date(left.termin_zeit || `${left.datum || ''}T${left.uhrzeit || '00:00'}:00`).getTime();
                const rightTime = new Date(right.termin_zeit || `${right.datum || ''}T${right.uhrzeit || '00:00'}:00`).getTime();
                return leftTime - rightTime;
            });
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bewerber-Konto</th>
                            <th>Name</th>
                            <th>E-Mail</th>
                            <th>Datum</th>
                            <th>Uhrzeit</th>
                            <th>Gebucht am</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedTermine.map((termin) => `
                            <tr>
                                <td>${termin.id}</td>
                                <td>${escapeHtml(`${termin.user_vorname || ''} ${termin.user_nachname || ''}`.trim() || termin.user_email || '—')}</td>
                                <td>${escapeHtml(termin.name || '—')}</td>
                                <td>${escapeHtml(termin.email || '—')}</td>
                                <td>${escapeHtml(termin.datum || '—')}</td>
                                <td>${escapeHtml(termin.uhrzeit || '—')}</td>
                                <td>${formatDate(termin.erstellt_am)}</td>
                                <td>
                                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                        <button class="btn-secondary" type="button" onclick="assignTaskFromTermin(${Number(termin.id)}, ${Number(termin.user_id)})">Aufgabe zuteilen</button>
                                        <button class="btn-danger" type="button" onclick="deleteAdminAppointment(${Number(termin.id)})">Termin löschen</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deleteAdminAppointment(terminId) {
            const confirmed = confirm('Diesen Termin im Adminpanel wirklich löschen?');
            if (!confirmed) return;

            try {
                await api(`/api/admin/termine/${Number(terminId)}`, { method: 'DELETE' });
                showTaskManageAlert('Termin erfolgreich gelöscht.', 'success');
                await refreshAppointmentsDataOnly();
            } catch (error) {
                showTaskManageAlert(error.message || 'Termin konnte nicht gelöscht werden.');
            }
        }

        function assignTaskFromTermin(terminId, userId) {
            const termin = adminAppointments.find((entry) => Number(entry.id) === Number(terminId));
            if (!termin) {
                showTaskManageAlert('Termin konnte nicht geladen werden.');
                return;
            }

            switchAdminTab('tasks');

            const userSelect = document.getElementById('taskUserId');
            if (userSelect) {
                userSelect.value = String(userId);
            }

            const titleInput = document.getElementById('taskTitel');
            if (titleInput && !titleInput.value.trim()) {
                titleInput.value = 'Vorbereitung auf Bewerbungstermin';
            }

            const dueInput = document.getElementById('taskFaelligAm');
            if (dueInput && termin.datum) {
                dueInput.value = String(termin.datum);
            }

            const descriptionInput = document.getElementById('taskBeschreibung');
            if (descriptionInput && !descriptionInput.value.trim()) {
                descriptionInput.value = `Bitte Unterlagen für den Termin am ${termin.datum || '—'} um ${termin.uhrzeit || '—'} prüfen und vorbereiten.`;
            }

            const userLabel = `${termin.user_vorname || ''} ${termin.user_nachname || ''}`.trim() || termin.user_email || 'Bewerber';
            showTaskManageAlert(`Termin #${terminId}: Aufgabe für ${userLabel} vorbereitet. Bitte zuweisen.`, 'success');
        }

        function getChatDisplayName(conversation) {
            const fullName = `${conversation.visitor_vorname || ''} ${conversation.visitor_nachname || ''}`.trim();
            return fullName || conversation.visitor_email || 'Unbekannt';
        }

        function renderChatThreads() {
            const scopedThreads = getChatThreadsByScope(activeChatScope);
            const activeConversationId = getActiveChatConversationId();

            if (!scopedThreads.length) {
                const emptyText = activeChatScope === 'livechats'
                    ? 'Keine Livechats vorhanden.'
                    : 'Keine Nachrichten von Nutzern vorhanden.';
                return `<div class="empty-state"><i class="fas fa-comments"></i><p>${escapeHtml(emptyText)}</p></div>`;
            }

            return scopedThreads.map((conversation) => {
                const active = String(conversation.conversation_id) === String(activeConversationId);
                const senderLabel = conversation.letzte_nachricht_von_admin
                    ? (conversation.letzte_admin_anzeige_name || adminChatDisplayName || 'Admin')
                    : getChatDisplayName(conversation);
                const status = formatConversationStatus(conversation.conversation_status);
                return `
                    <button type="button" class="chat-thread-item ${active ? 'active' : ''}" onclick="openAdminConversation('${escapeHtml(conversation.conversation_id)}')">
                        <div class="chat-thread-top">
                            <strong>${escapeHtml(getChatDisplayName(conversation))}</strong>
                            <small>${escapeHtml(formatDate(conversation.letzte_nachricht_am))}</small>
                        </div>
                        <div><span class="chat-status-badge ${status.key}">${escapeHtml(status.label)}</span></div>
                        <div class="chat-thread-meta">${escapeHtml(conversation.visitor_email || 'Keine E-Mail')}</div>
                        <div class="chat-thread-preview">${escapeHtml(senderLabel)}: ${escapeHtml(conversation.letzte_nachricht || '')}</div>
                    </button>
                `;
            }).join('');
        }

        function renderChatMessages(messages) {
            if (!messages.length) {
                return '<div class="chat-empty">Noch keine Nachrichten in dieser Konversation.</div>';
            }

            return messages.map((message) => {
                const isAdmin = Boolean(message.admin_id);
                const isEditable = isAdmin;
                const label = isAdmin ? getAdminMessageName(message) : getVisitorMessageName(message);
                const bubbleClass = isAdmin ? 'chat-message chat-message-admin' : 'chat-message chat-message-visitor';
                return `
                    <div class="${bubbleClass}">
                        <div class="chat-message-head">
                            <span>${escapeHtml(label)}</span>
                            <small>${escapeHtml(formatDate(message.erstellt_am))}</small>
                        </div>
                        <div class="chat-message-text">${escapeHtml(message.nachricht || '')}</div>
                        ${isEditable ? `<div class="chat-message-actions"><button type="button" class="btn-secondary" onclick="startEditChatMessage(${Number(message.id)})">Bearbeiten</button></div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderChats() {
            const scopedThreads = getChatThreadsByScope(activeChatScope);
            const activeConversationId = getActiveChatConversationId();
            const isMessagesScope = activeChatScope === 'chats';
            const layoutScopeClass = isMessagesScope ? 'scope-messages' : 'scope-livechat';
            const panelTitle = isMessagesScope ? 'Nachrichten-Funktionen' : 'Live-Funktionen';

            const activeConversation = scopedThreads.find(
                (conversation) => String(conversation.conversation_id) === String(activeConversationId)
            );
            const conversationTitle = activeConversation ? getChatDisplayName(activeConversation) : 'Konversation auswählen';
            const submitLabel = editingChatMessageId ? 'Änderung speichern' : 'Antwort senden';
            const statusInfo = formatConversationStatus(activeChatConversationMeta?.conversation_status || activeConversation?.conversation_status || 'offen');
            const conversationBlocked = ['geschlossen', 'erledigt'].includes(statusInfo.key);

            return `
                <div class="chat-admin-layout ${layoutScopeClass}">
                    <aside class="chat-admin-sidebar" id="chatThreadList">
                        ${renderChatThreads()}
                    </aside>
                    <section class="chat-admin-main">
                        <div class="chat-admin-header">
                            <strong>${escapeHtml(conversationTitle)}</strong>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="chat-status-badge ${statusInfo.key}">${escapeHtml(statusInfo.label)}</span>
                                <small>${escapeHtml(activeConversation?.visitor_email || '')}</small>
                            </div>
                        </div>
                        <div class="chat-live-panel">
                            <div class="chat-live-panel-title">${escapeHtml(panelTitle)}</div>
                            <div class="chat-admin-controls">
                                <select class="form-input" id="chatConversationStatus" ${activeConversation ? '' : 'disabled'}>
                                    <option value="offen" ${statusInfo.key === 'offen' ? 'selected' : ''}>Offen</option>
                                    <option value="in_bearbeitung" ${statusInfo.key === 'in_bearbeitung' ? 'selected' : ''}>In Bearbeitung</option>
                                    <option value="erledigt" ${statusInfo.key === 'erledigt' ? 'selected' : ''}>Erledigt</option>
                                    <option value="geschlossen" ${statusInfo.key === 'geschlossen' ? 'selected' : ''}>Geschlossen</option>
                                </select>
                                <button class="btn-secondary" type="button" id="applyChatStatusBtn" ${activeConversation ? '' : 'disabled'}>Status setzen</button>
                                <button class="btn-secondary" type="button" id="reopenChatBtn" ${activeConversation ? '' : 'disabled'}>Wieder öffnen</button>
                                <button class="btn-danger" type="button" id="deleteChatBtn" ${activeConversation ? '' : 'disabled'}>Löschen</button>
                            </div>
                            <div class="chat-admin-name-row">
                                <label for="chatAdminDisplayName" style="color: var(--gray); font-size: 12px;">Antwortname im Chat</label>
                                <div style="display:grid; grid-template-columns: 1fr auto; gap: 8px;">
                                    <input class="form-input" id="chatAdminDisplayName" type="text" maxlength="80" placeholder="z. B. Nina vom Support" value="${escapeHtml(adminChatDisplayName)}" />
                                    <button class="btn-secondary" type="button" id="saveChatAdminNameBtn">Speichern</button>
                                </div>
                            </div>
                        </div>
                        <div class="chat-admin-messages" id="chatMessageList">
                            ${renderChatMessages(activeChatMessages)}
                        </div>
                        <form id="chatReplyForm" class="chat-admin-form">
                            <input class="form-input" id="chatReplyInput" type="text" maxlength="1200" placeholder="${conversationBlocked ? 'Konversation ist geschlossen/erledigt' : 'Nachricht schreiben...'}" ${(activeConversation && !conversationBlocked) ? '' : 'disabled'} />
                            <button class="btn-primary" type="submit" ${(activeConversation && !conversationBlocked) ? '' : 'disabled'}>${submitLabel}</button>
                        </form>
                    </section>
                </div>
            `;
        }

        async function openAdminConversation(conversationId) {
            setActiveChatConversationId(conversationId);
            editingChatMessageId = null;
            await refreshActiveConversationMessages();
            document.getElementById('chatsTable').innerHTML = renderChats();
            bindChatReplyForm();
            const messageList = document.getElementById('chatMessageList');
            if (messageList) {
                messageList.scrollTop = messageList.scrollHeight;
            }
        }

        async function refreshActiveConversationMessages() {
            const activeConversationId = getActiveChatConversationId();
            if (!activeConversationId) {
                activeChatMessages = [];
                activeChatConversationMeta = null;
                return;
            }

            const result = await api(`/api/admin/chats/${encodeURIComponent(activeConversationId)}/messages`);
            activeChatMessages = result.messages || [];
            activeChatConversationMeta = result.conversation || null;
        }

        async function applyConversationStatus(status) {
            const activeConversationId = getActiveChatConversationId();
            if (!activeConversationId) return;

            await api(`/api/admin/chats/${encodeURIComponent(activeConversationId)}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });

            await refreshChatDataOnly();
            await openAdminConversation(activeConversationId);
        }

        async function deleteActiveConversation() {
            const activeConversationId = getActiveChatConversationId();
            if (!activeConversationId) return;
            const confirmed = confirm('Konversation wirklich löschen?');
            if (!confirmed) return;

            await api(`/api/admin/chats/${encodeURIComponent(activeConversationId)}`, {
                method: 'DELETE'
            });

            await refreshChatDataOnly();
            const remainingActiveId = getActiveChatConversationId();
            if (remainingActiveId) {
                await openAdminConversation(remainingActiveId);
            } else {
                document.getElementById('chatsTable').innerHTML = renderChats();
                bindChatReplyForm();
            }
        }

        function startEditChatMessage(chatId) {
            const target = activeChatMessages.find((entry) => Number(entry.id) === Number(chatId));
            if (!target) return;

            editingChatMessageId = Number(chatId);
            const input = document.getElementById('chatReplyInput');
            if (input) {
                input.value = target.nachricht || '';
                input.focus();
            }
            const submitBtn = document.querySelector('#chatReplyForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Änderung speichern';
            }
        }

        async function submitChatReply(event) {
            event.preventDefault();
            const activeConversationId = getActiveChatConversationId();
            if (!activeConversationId) return;

            const input = document.getElementById('chatReplyInput');
            const text = String(input?.value || '').trim();
            if (!text) return;

            if (editingChatMessageId) {
                await api(`/api/admin/chats/${editingChatMessageId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nachricht: text })
                });
            } else {
                const currentAdminDisplayName = syncAdminDisplayNameFromInput();
                await api(`/api/admin/chats/${encodeURIComponent(activeConversationId)}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nachricht: text,
                        adminAnzeigename: currentAdminDisplayName
                    })
                });
            }

            input.value = '';
            editingChatMessageId = null;
            await refreshChatDataOnly();
            await openAdminConversation(activeConversationId);
        }

        function bindChatReplyForm() {
            const form = document.getElementById('chatReplyForm');
            if (!form) return;

            const saveDisplayNameButton = document.getElementById('saveChatAdminNameBtn');
            const nameInput = document.getElementById('chatAdminDisplayName');
            const applyStatusButton = document.getElementById('applyChatStatusBtn');
            const statusSelect = document.getElementById('chatConversationStatus');
            const reopenButton = document.getElementById('reopenChatBtn');
            const deleteButton = document.getElementById('deleteChatBtn');

            if (saveDisplayNameButton && nameInput) {
                saveDisplayNameButton.addEventListener('click', () => {
                    syncAdminDisplayNameFromInput();
                    const chatsTable = document.getElementById('chatsTable');
                    if (chatsTable) {
                        chatsTable.innerHTML = renderChats();
                        bindChatReplyForm();
                    }
                });

                nameInput.addEventListener('blur', () => {
                    syncAdminDisplayNameFromInput();
                });
            }

            if (applyStatusButton && statusSelect) {
                applyStatusButton.addEventListener('click', async () => {
                    try {
                        await applyConversationStatus(String(statusSelect.value || 'offen').trim().toLowerCase());
                    } catch (error) {
                        alert(error.message || 'Status konnte nicht aktualisiert werden.');
                    }
                });
            }

            if (reopenButton) {
                reopenButton.addEventListener('click', async () => {
                    try {
                        await applyConversationStatus('offen');
                    } catch (error) {
                        alert(error.message || 'Konversation konnte nicht geöffnet werden.');
                    }
                });
            }

            if (deleteButton) {
                deleteButton.addEventListener('click', async () => {
                    try {
                        await deleteActiveConversation();
                    } catch (error) {
                        alert(error.message || 'Konversation konnte nicht gelöscht werden.');
                    }
                });
            }

            form.addEventListener('submit', async (event) => {
                try {
                    await submitChatReply(event);
                } catch (error) {
                    alert(error.message || 'Fehler beim Senden der Nachricht.');
                }
            });
        }

        async function refreshChatDataOnly() {
            const chatsRes = await api('/api/admin/chats');
            const allConversations = chatsRes.conversations || [];
            adminLiveChatThreads = allConversations.filter((conversation) => !conversation.user_id);
            adminMessageThreads = allConversations.filter((conversation) => Boolean(conversation.user_id));

            const scopedThreads = getChatThreadsByScope(activeChatScope);
            const activeConversationId = getActiveChatConversationId();

            if (!scopedThreads.length) {
                setActiveChatConversationId('');
                activeChatMessages = [];
                activeChatConversationMeta = null;
                return;
            }

            const stillExists = scopedThreads.some(
                (conversation) => String(conversation.conversation_id) === String(activeConversationId)
            );

            if (!stillExists) {
                setActiveChatConversationId(String(scopedThreads[0].conversation_id));
                activeChatMessages = [];
            }
        }

        async function refreshAppointmentsDataOnly() {
            const appointmentsRes = await api('/api/admin/termine');
            adminAppointments = appointmentsRes.termine || [];
            const appointmentsTable = document.getElementById('appointmentsTable');
            if (appointmentsTable) {
                appointmentsTable.innerHTML = renderAppointments(adminAppointments);
            }
        }

        async function loadAdminData() {
            const [overview, usersRes, jobsRes, bewerbungenRes, tasksRes, appointmentsRes, favoritenRes, chatsRes] = await Promise.all([
                api('/api/admin/overview'),
                api('/api/admin/users'),
                api('/api/admin/jobs'),
                api('/api/admin/bewerbungen'),
                api('/api/admin/tasks'),
                api('/api/admin/termine'),
                api('/api/admin/favoriten'),
                api('/api/admin/chats')
            ]);

            document.getElementById('countUsers').textContent = overview.stats.totalUsers;
            document.getElementById('countJobs').textContent = jobsRes.jobs.length;
            document.getElementById('countBewerbungen').textContent = bewerbungenRes.bewerbungen.length;
            document.getElementById('countFavoriten').textContent = favoritenRes.favoriten.length;

            adminUsers = usersRes.users || [];
            adminJobs = jobsRes.jobs || [];
            adminAppointments = appointmentsRes.termine || [];
            const allConversations = chatsRes.conversations || [];
            adminLiveChatThreads = allConversations.filter((conversation) => !conversation.user_id);
            adminMessageThreads = allConversations.filter((conversation) => Boolean(conversation.user_id));

            for (const scope of ['livechats', 'chats']) {
                const scopedThreads = getChatThreadsByScope(scope);
                const activeIdForScope = String(activeChatConversationIds[scope] || '');
                const exists = scopedThreads.some((conversation) => String(conversation.conversation_id) === activeIdForScope);
                if (!exists) {
                    activeChatConversationIds[scope] = scopedThreads.length
                        ? String(scopedThreads[0].conversation_id)
                        : '';
                }
            }

            if (getActiveChatConversationId()) {
                await refreshActiveConversationMessages();
            } else {
                activeChatMessages = [];
                activeChatConversationMeta = null;
            }

            document.getElementById('usersTable').innerHTML = renderUsers(usersRes.users);
            document.getElementById('jobsTable').innerHTML = renderJobs(jobsRes.jobs);
            document.getElementById('bewerbungenTable').innerHTML = renderBewerbungen(bewerbungenRes.bewerbungen);
            document.getElementById('tasksTable').innerHTML = renderTasks(tasksRes.tasks);
            document.getElementById('appointmentsTable').innerHTML = renderAppointments(adminAppointments);
            document.getElementById('favoritenTable').innerHTML = renderFavoriten(favoritenRes.favoriten);
            document.getElementById('chatsTable').innerHTML = renderChats();
            bindChatReplyForm();
            populateTaskAssigneeOptions(usersRes.users);
        }

        async function ensureAdmin() {
            const session = await api('/api/check-session');
            if (!session.isAuthenticated) {
                window.location.href = 'login.html';
                return false;
            }

            const user = await api('/api/user');
            if (user.user_typ !== 'admin') {
                window.location.href = 'dashboard.html';
                return false;
            }

            if (!adminChatDisplayName) {
                adminChatDisplayName = `${user.vorname || ''} ${user.nachname || ''}`.trim() || user.email || '';
                localStorage.setItem(ADMIN_CHAT_NAME_STORAGE_KEY, adminChatDisplayName);
            }

            const taskSenderNameInput = document.getElementById('taskSenderName');
            if (taskSenderNameInput && !taskSenderNameInput.value.trim()) {
                taskSenderNameInput.value = `${user.vorname || ''} ${user.nachname || ''}`.trim() || user.email || '';
            }

            document.getElementById('welcome').textContent = `Admin Panel – ${user.vorname}`;
            return true;
        }

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            try {
                updateLivePollingStatus('active');
                await loadAdminData();
            } catch (error) {
                updateLivePollingStatus('error');
                alert(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await api('/api/logout', { method: 'POST' });
            window.location.href = 'index.html';
        });

        document.getElementById('closeEditModalBtn').addEventListener('click', closeEditModal);
        document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
        document.getElementById('editModalForm').addEventListener('submit', saveEditModal);

        document.getElementById('createJobForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                titel: document.getElementById('jobTitel').value.trim(),
                firma: document.getElementById('jobFirma').value.trim(),
                standort: document.getElementById('jobStandort').value.trim(),
                jobTyp: document.getElementById('jobTyp').value,
                beschreibung: document.getElementById('jobBeschreibung').value.trim()
            };

            try {
                await api('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showJobCreateAlert('Vermittlungsstelle erfolgreich erstellt.', 'success');
                document.getElementById('createJobForm').reset();
                await loadAdminData();
            } catch (error) {
                showJobCreateAlert(error.message || 'Fehler beim Erstellen der Vermittlungsstelle.');
            }
        });

        document.getElementById('createUserForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                vorname: document.getElementById('newUserVorname').value.trim(),
                nachname: document.getElementById('newUserNachname').value.trim(),
                email: document.getElementById('newUserEmail').value.trim(),
                passwort: document.getElementById('newUserPasswort').value,
                userTyp: document.getElementById('newUserTyp').value,
                firma: document.getElementById('newUserFirma').value.trim() || null
            };

            try {
                await api('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showUserManageAlert('Benutzer erfolgreich hinzugefügt.', 'success');
                document.getElementById('createUserForm').reset();
                await loadAdminData();
            } catch (error) {
                showUserManageAlert(error.message || 'Fehler beim Hinzufügen des Benutzers.');
            }
        });

        document.getElementById('assignTaskForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                userId: Number(document.getElementById('taskUserId').value),
                titel: document.getElementById('taskTitel').value.trim(),
                auftragVonName: document.getElementById('taskSenderName').value.trim() || null,
                status: document.getElementById('taskStatus').value,
                beschreibung: document.getElementById('taskBeschreibung').value.trim() || null,
                faelligAm: document.getElementById('taskFaelligAm').value || null
            };

            try {
                await api('/api/admin/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showTaskManageAlert('Aufgabe erfolgreich zugeteilt.', 'success');
                document.getElementById('assignTaskForm').reset();
                await loadAdminData();
            } catch (error) {
                showTaskManageAlert(error.message || 'Fehler beim Zuteilen der Aufgabe.');
            }
        });

        (async () => {
            try {
                const ok = await ensureAdmin();
                if (!ok) return;
                switchAdminTab(getInitialAdminTab());
                await loadAdminData();
                updateLivePollingStatus('active');

                if (adminChatPollHandle) {
                    clearInterval(adminChatPollHandle);
                }

                adminChatPollHandle = setInterval(async () => {
                    try {
                        if (isUserInteractingWithControls()) {
                            updateLivePollingStatus('paused');
                            return;
                        }

                        updateLivePollingStatus('active');

                        if (activeAdminTab === 'appointments') {
                            await refreshAppointmentsDataOnly();
                        }

                        if (activeAdminTab === 'chats' || activeAdminTab === 'livechats') {
                            await refreshChatDataOnly();
                            if (getActiveChatConversationId()) {
                                await refreshActiveConversationMessages();
                            }

                            const chatsTable = document.getElementById('chatsTable');
                            if (chatsTable) {
                                chatsTable.innerHTML = renderChats();
                                bindChatReplyForm();
                            }
                        }
                    } catch {
                        updateLivePollingStatus('error');
                        // polling errors are ignored to keep the UI responsive
                    }
                }, 3000);
            } catch (error) {
                alert(error.message);
            }
        })();
    </script>
    <script src="chat-widget.js"></script>
</body>
</html>
