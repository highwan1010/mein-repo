<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - JobVermittlung</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <div class="logo"><i class="fas fa-shield-alt"></i><span>JobVermittlung Admin</span></div>
                <div class="nav-buttons">
                    <button class="btn-secondary" onclick="window.location.href='index.html'">Startseite</button>
                    <button class="btn-secondary" onclick="window.location.href='dashboard.html'">Dashboard</button>
                    <button class="btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-top">
                <div>
                    <h1 id="welcome">Admin Panel</h1>
                    <p id="subtitle" style="color: var(--gray);">Vollständige Systemeinsicht in Vermittlungsstellen, Bewerbungen, Nutzer und Aufgaben.</p>
                </div>
                <button class="btn-primary" id="refreshBtn"><i class="fas fa-rotate"></i> Aktualisieren</button>
            </div>

            <div class="panel-grid">
                <div class="panel"><div style="color: var(--gray);">Benutzer</div><div class="value" id="countUsers">0</div></div>
                <div class="panel"><div style="color: var(--gray);">Jobs</div><div class="value" id="countJobs">0</div></div>
                <div class="panel"><div style="color: var(--gray);">Bewerbungen</div><div class="value" id="countBewerbungen">0</div></div>
                <div class="panel"><div style="color: var(--gray);">Favoriten</div><div class="value" id="countFavoriten">0</div></div>
            </div>

            <section class="card">
                <h2 style="margin-bottom: 10px;">Neue Vermittlungsstelle erstellen</h2>
                <div id="jobCreateAlert"></div>
                <form id="createJobForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="jobTitel">Titel</label>
                            <input class="form-input" type="text" id="jobTitel" required />
                        </div>
                        <div class="form-group">
                            <label for="jobFirma">Firma</label>
                            <input class="form-input" type="text" id="jobFirma" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="jobStandort">Standort</label>
                            <input class="form-input" type="text" id="jobStandort" required />
                        </div>
                        <div class="form-group">
                            <label for="jobTyp">Beschäftigungsart</label>
                            <select class="form-input" id="jobTyp">
                                <option value="Vollzeit">Vollzeit</option>
                                <option value="Teilzeit">Teilzeit</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Remote">Remote</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="jobBeschreibung">Beschreibung</label>
                        <textarea class="form-input" id="jobBeschreibung" rows="4" required></textarea>
                    </div>
                    <button class="btn-primary" type="submit">
                        <i class="fas fa-plus"></i> Vermittlungsstelle erstellen
                    </button>
                </form>
            </section>

            <section class="card">
                <h2 style="margin-bottom: 10px;">Benutzer</h2>
                <div id="userManageAlert"></div>
                <form id="createUserForm" style="margin-bottom: 16px;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="newUserVorname">Vorname</label>
                            <input class="form-input" id="newUserVorname" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="newUserNachname">Nachname</label>
                            <input class="form-input" id="newUserNachname" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="newUserEmail">E-Mail</label>
                            <input class="form-input" id="newUserEmail" type="email" required />
                        </div>
                        <div class="form-group">
                            <label for="newUserPasswort">Passwort</label>
                            <input class="form-input" id="newUserPasswort" type="password" minlength="6" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="newUserTyp">Typ</label>
                            <select class="form-input" id="newUserTyp">
                                <option value="bewerber">Bewerber</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newUserFirma">Firma (optional)</label>
                            <input class="form-input" id="newUserFirma" type="text" />
                        </div>
                    </div>
                    <button class="btn-primary" type="submit">
                        <i class="fas fa-user-plus"></i> Benutzer hinzufügen
                    </button>
                </form>
                <div id="usersTable">Lade Daten...</div>
            </section>

            <section class="card">
                <h2 style="margin-bottom: 10px;">Jobs</h2>
                <div id="jobsTable">Lade Daten...</div>
            </section>

            <section class="card">
                <h2 style="margin-bottom: 10px;">Bewerbungen</h2>
                <div id="bewerbungenTable">Lade Daten...</div>
            </section>

            <section class="card">
                <h2 style="margin-bottom: 10px;">Aufgaben zuteilen</h2>
                <div id="taskManageAlert"></div>
                <form id="assignTaskForm" style="margin-bottom: 16px;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="taskUserId">Bewerber</label>
                            <select class="form-input" id="taskUserId" required></select>
                        </div>
                        <div class="form-group">
                            <label for="taskTitel">Titel</label>
                            <input class="form-input" id="taskTitel" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="taskStatus">Status</label>
                            <select class="form-input" id="taskStatus" required>
                                <option value="offen">Offen</option>
                                <option value="in_bearbeitung">In Bearbeitung</option>
                                <option value="erledigt">Erledigt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskFaelligAm">Fällig am (optional)</label>
                            <input class="form-input" id="taskFaelligAm" type="date" />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="taskBeschreibung">Beschreibung (optional)</label>
                            <input class="form-input" id="taskBeschreibung" type="text" />
                        </div>
                        <div></div>
                    </div>
                    <button class="btn-primary" type="submit">
                        <i class="fas fa-list-check"></i> Aufgabe zuweisen
                    </button>
                </form>
                <div id="tasksTable">Lade Daten...</div>
            </section>

            <section class="card">
                <h2 style="margin-bottom: 10px;">Favoriten</h2>
                <div id="favoritenTable">Lade Daten...</div>
            </section>
        </div>
    </main>

    <div class="modal" id="editModal">
        <div class="modal-card" style="max-width: 880px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 14px;">
                <h2 id="editModalTitle">Bearbeiten</h2>
                <button class="btn-secondary" type="button" id="closeEditModalBtn">Schließen</button>
            </div>

            <div id="editModalAlert"></div>

            <form id="editModalForm">
                <div id="userEditFields" style="display:none;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editUserVorname">Vorname</label>
                            <input class="form-input" id="editUserVorname" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editUserNachname">Nachname</label>
                            <input class="form-input" id="editUserNachname" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editUserEmail">E-Mail</label>
                            <input class="form-input" id="editUserEmail" type="email" required />
                        </div>
                        <div class="form-group">
                            <label for="editUserTyp">Typ</label>
                            <select class="form-input" id="editUserTyp" required>
                                <option value="bewerber">Bewerber</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editUserFirma">Firma (optional)</label>
                        <input class="form-input" id="editUserFirma" type="text" />
                    </div>
                </div>

                <div id="jobEditFields" style="display:none;">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editJobTitel">Titel</label>
                            <input class="form-input" id="editJobTitel" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editJobFirma">Firma</label>
                            <input class="form-input" id="editJobFirma" type="text" required />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editJobStandort">Standort</label>
                            <input class="form-input" id="editJobStandort" type="text" required />
                        </div>
                        <div class="form-group">
                            <label for="editJobTyp">Beschäftigungsart</label>
                            <input class="form-input" id="editJobTyp" type="text" />
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="editJobStatus">Status</label>
                            <select class="form-input" id="editJobStatus" required>
                                <option value="aktiv">Aktiv</option>
                                <option value="pausiert">Pausiert</option>
                                <option value="geschlossen">Geschlossen</option>
                            </select>
                        </div>
                        <div></div>
                    </div>
                    <div class="form-group">
                        <label for="editJobBeschreibung">Beschreibung</label>
                        <textarea class="form-input" id="editJobBeschreibung" rows="5"></textarea>
                    </div>
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                    <button class="btn-secondary" type="button" id="cancelEditBtn">Abbrechen</button>
                    <button class="btn-primary" type="submit">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL)
            ? String(window.APP_CONFIG.API_BASE_URL).replace(/\/$/, '')
            : '';
        let adminUsers = [];
        let adminJobs = [];
        let editContext = null;

        function escapeHtml(value) {
            return String(value ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function formatDate(value) {
            if (!value) return '—';
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? '—' : date.toLocaleString('de-DE');
        }

        function formatTaskStatus(status) {
            const normalized = String(status || 'offen');
            if (normalized === 'erledigt') {
                return { label: 'Erledigt', className: 'success' };
            }
            if (normalized === 'in_bearbeitung') {
                return { label: 'In Bearbeitung', className: 'warning' };
            }
            return { label: 'Offen', className: '' };
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_BASE}${path}`, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Fehler');
            return data;
        }

        function showJobCreateAlert(message, type = 'error') {
            document.getElementById('jobCreateAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function showUserManageAlert(message, type = 'error') {
            document.getElementById('userManageAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function showTaskManageAlert(message, type = 'error') {
            document.getElementById('taskManageAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function populateTaskAssigneeOptions(users) {
            const select = document.getElementById('taskUserId');
            const bewerber = users.filter((user) => user.user_typ === 'bewerber');
            if (!bewerber.length) {
                select.innerHTML = '<option value="">Keine Bewerber verfügbar</option>';
                select.disabled = true;
                return;
            }

            select.disabled = false;
            select.innerHTML = bewerber.map((user) => {
                const fullName = `${user.vorname || ''} ${user.nachname || ''}`.trim();
                return `<option value="${user.id}">${escapeHtml(fullName || user.email)} (${escapeHtml(user.email)})</option>`;
            }).join('');
        }

        function renderUsers(users) {
            if (!users.length) return '<p>Keine Benutzer vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>E-Mail</th>
                            <th>Typ</th>
                            <th>Firma</th>
                            <th>Erstellt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map((user) => `
                            <tr>
                                <td>${user.id}</td>
                                <td>${escapeHtml(`${user.vorname || ''} ${user.nachname || ''}`.trim())}</td>
                                <td>${escapeHtml(user.email)}</td>
                                <td><span class="badge">${escapeHtml(user.user_typ)}</span></td>
                                <td>${escapeHtml(user.firma || '—')}</td>
                                <td>${formatDate(user.erstellt_am)}</td>
                                <td>
                                    <button class="btn-secondary" onclick="editUser(${user.id})">
                                        Bearbeiten
                                    </button>
                                    <button class="btn-danger" style="margin-left:8px;" onclick="deleteUser(${user.id})">
                                        Löschen
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editModalAlert').innerHTML = '';
            editContext = null;
        }

        function showEditModalAlert(message, type = 'error') {
            document.getElementById('editModalAlert').innerHTML = `<div class="alert ${type}">${escapeHtml(message)}</div>`;
        }

        function editUser(id) {
            const user = adminUsers.find((item) => Number(item.id) === Number(id));
            if (!user) {
                showUserManageAlert('Benutzer nicht gefunden.');
                return;
            }

            editContext = { type: 'user', id: Number(id) };
            document.getElementById('editModalTitle').textContent = `Benutzer bearbeiten (#${id})`;
            document.getElementById('userEditFields').style.display = 'block';
            document.getElementById('jobEditFields').style.display = 'none';

            document.getElementById('editUserVorname').value = user.vorname || '';
            document.getElementById('editUserNachname').value = user.nachname || '';
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserTyp').value = user.user_typ || 'bewerber';
            document.getElementById('editUserFirma').value = user.firma || '';

            openEditModal();
        }

        async function deleteUser(id) {
            const user = adminUsers.find((item) => Number(item.id) === Number(id));
            const email = user ? (user.email || `#${id}`) : `#${id}`;
            const confirmed = confirm(`Benutzer ${email} wirklich löschen?`);
            if (!confirmed) return;

            try {
                await api(`/api/admin/users/${id}`, { method: 'DELETE' });
                showUserManageAlert('Benutzer erfolgreich gelöscht.', 'success');
                await loadAdminData();
            } catch (error) {
                showUserManageAlert(error.message || 'Fehler beim Löschen des Benutzers.');
            }
        }

        function renderJobs(jobs) {
            if (!jobs.length) return '<p>Keine Jobs vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Titel</th>
                            <th>Firma</th>
                            <th>Standort</th>
                            <th>Status</th>
                            <th>Arbeitgeber</th>
                            <th>Erstellt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jobs.map((job) => `
                            <tr>
                                <td>${job.id}</td>
                                <td>${escapeHtml(job.titel)}</td>
                                <td>${escapeHtml(job.firma)}</td>
                                <td>${escapeHtml(job.standort)}</td>
                                <td><span class="badge ${job.status === 'aktiv' ? 'success' : 'warning'}">${escapeHtml(job.status || '—')}</span></td>
                                <td>${escapeHtml(`${job.arbeitgeber_vorname || ''} ${job.arbeitgeber_nachname || ''}`.trim() || job.arbeitgeber_email || '—')}</td>
                                <td>${formatDate(job.erstellt_am)}</td>
                                <td>
                                    <button class="btn-secondary" onclick="editJob(${job.id})">
                                        Bearbeiten
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function editJob(id) {
            const job = adminJobs.find((item) => Number(item.id) === Number(id));
            if (!job) {
                showJobCreateAlert('Job nicht gefunden.');
                return;
            }

            editContext = { type: 'job', id: Number(id) };
            document.getElementById('editModalTitle').textContent = `Job bearbeiten (#${id})`;
            document.getElementById('userEditFields').style.display = 'none';
            document.getElementById('jobEditFields').style.display = 'block';

            document.getElementById('editJobTitel').value = job.titel || '';
            document.getElementById('editJobFirma').value = job.firma || '';
            document.getElementById('editJobStandort').value = job.standort || '';
            document.getElementById('editJobTyp').value = job.job_typ || '';
            document.getElementById('editJobStatus').value = job.status || 'aktiv';
            document.getElementById('editJobBeschreibung').value = job.beschreibung || '';

            openEditModal();
        }

        async function saveEditModal(event) {
            event.preventDefault();
            if (!editContext) return;

            try {
                if (editContext.type === 'user') {
                    const userTyp = String(document.getElementById('editUserTyp').value).trim().toLowerCase();
                    if (!['bewerber', 'admin'].includes(userTyp)) {
                        showEditModalAlert('Ungültiger Benutzer-Typ.');
                        return;
                    }

                    await api(`/api/admin/users/${editContext.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            vorname: document.getElementById('editUserVorname').value.trim(),
                            nachname: document.getElementById('editUserNachname').value.trim(),
                            email: document.getElementById('editUserEmail').value.trim(),
                            userTyp,
                            firma: document.getElementById('editUserFirma').value.trim() || null
                        })
                    });

                    showUserManageAlert('Benutzer erfolgreich aktualisiert.', 'success');
                }

                if (editContext.type === 'job') {
                    await api(`/api/admin/jobs/${editContext.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            titel: document.getElementById('editJobTitel').value.trim(),
                            firma: document.getElementById('editJobFirma').value.trim(),
                            standort: document.getElementById('editJobStandort').value.trim(),
                            jobTyp: document.getElementById('editJobTyp').value.trim(),
                            status: document.getElementById('editJobStatus').value,
                            beschreibung: document.getElementById('editJobBeschreibung').value.trim()
                        })
                    });

                    showJobCreateAlert('Vermittlungsstelle erfolgreich aktualisiert.', 'success');
                }

                await loadAdminData();
                closeEditModal();
            } catch (error) {
                showEditModalAlert(error.message || 'Speichern fehlgeschlagen.');
            }
        }

        function renderBewerbungen(bewerbungen) {
            if (!bewerbungen.length) return '<p>Keine Bewerbungen vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bewerber</th>
                            <th>Job</th>
                            <th>Firma</th>
                            <th>Status</th>
                            <th>Erstellt</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bewerbungen.map((bewerbung) => `
                            <tr>
                                <td>${bewerbung.id}</td>
                                <td>${escapeHtml(`${bewerbung.bewerber_vorname || ''} ${bewerbung.bewerber_nachname || ''}`.trim() || bewerbung.bewerber_email || '—')}</td>
                                <td>${escapeHtml(bewerbung.job_titel || '—')}</td>
                                <td>${escapeHtml(bewerbung.job_firma || '—')}</td>
                                <td><span class="badge">${escapeHtml(bewerbung.status || '—')}</span></td>
                                <td>${formatDate(bewerbung.erstellt_am)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderFavoriten(favoriten) {
            if (!favoriten.length) return '<p>Keine Favoriten vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Benutzer</th>
                            <th>Job</th>
                            <th>Firma</th>
                            <th>Gespeichert am</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${favoriten.map((favorit) => `
                            <tr>
                                <td>${favorit.id}</td>
                                <td>${escapeHtml(`${favorit.user_vorname || ''} ${favorit.user_nachname || ''}`.trim() || favorit.user_email || '—')}</td>
                                <td>${escapeHtml(favorit.job_titel || '—')}</td>
                                <td>${escapeHtml(favorit.job_firma || '—')}</td>
                                <td>${formatDate(favorit.erstellt_am || favorit.favorit_seit)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderTasks(tasks) {
            if (!tasks.length) return '<p>Keine Aufgaben vorhanden.</p>';
            return `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bewerber</th>
                            <th>Titel</th>
                            <th>Status</th>
                            <th>Fällig</th>
                            <th>Erstellt</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tasks.map((task) => {
                            const taskStatus = formatTaskStatus(task.status);
                            return `
                            <tr>
                                <td>${task.id}</td>
                                <td>${escapeHtml(`${task.user_vorname || ''} ${task.user_nachname || ''}`.trim() || task.user_email || '—')}</td>
                                <td>${escapeHtml(task.titel || '—')}</td>
                                <td><span class="badge ${taskStatus.className}">${taskStatus.label}</span></td>
                                <td>${formatDate(task.faellig_am)}</td>
                                <td>${formatDate(task.erstellt_am)}</td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        async function loadAdminData() {
            const [overview, usersRes, jobsRes, bewerbungenRes, tasksRes, favoritenRes] = await Promise.all([
                api('/api/admin/overview'),
                api('/api/admin/users'),
                api('/api/admin/jobs'),
                api('/api/admin/bewerbungen'),
                api('/api/admin/tasks'),
                api('/api/admin/favoriten')
            ]);

            document.getElementById('countUsers').textContent = overview.stats.totalUsers;
            document.getElementById('countJobs').textContent = jobsRes.jobs.length;
            document.getElementById('countBewerbungen').textContent = bewerbungenRes.bewerbungen.length;
            document.getElementById('countFavoriten').textContent = favoritenRes.favoriten.length;

            adminUsers = usersRes.users || [];
            adminJobs = jobsRes.jobs || [];

            document.getElementById('usersTable').innerHTML = renderUsers(usersRes.users);
            document.getElementById('jobsTable').innerHTML = renderJobs(jobsRes.jobs);
            document.getElementById('bewerbungenTable').innerHTML = renderBewerbungen(bewerbungenRes.bewerbungen);
            document.getElementById('tasksTable').innerHTML = renderTasks(tasksRes.tasks);
            document.getElementById('favoritenTable').innerHTML = renderFavoriten(favoritenRes.favoriten);
            populateTaskAssigneeOptions(usersRes.users);
        }

        async function ensureAdmin() {
            const session = await api('/api/check-session');
            if (!session.isAuthenticated) {
                window.location.href = 'login.html';
                return false;
            }

            const user = await api('/api/user');
            if (user.user_typ !== 'admin') {
                window.location.href = 'dashboard.html';
                return false;
            }

            document.getElementById('welcome').textContent = `Admin Panel – ${user.vorname}`;
            return true;
        }

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            try {
                await loadAdminData();
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await api('/api/logout', { method: 'POST' });
            window.location.href = 'index.html';
        });

        document.getElementById('closeEditModalBtn').addEventListener('click', closeEditModal);
        document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
        document.getElementById('editModalForm').addEventListener('submit', saveEditModal);

        document.getElementById('createJobForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                titel: document.getElementById('jobTitel').value.trim(),
                firma: document.getElementById('jobFirma').value.trim(),
                standort: document.getElementById('jobStandort').value.trim(),
                jobTyp: document.getElementById('jobTyp').value,
                beschreibung: document.getElementById('jobBeschreibung').value.trim()
            };

            try {
                await api('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showJobCreateAlert('Vermittlungsstelle erfolgreich erstellt.', 'success');
                document.getElementById('createJobForm').reset();
                await loadAdminData();
            } catch (error) {
                showJobCreateAlert(error.message || 'Fehler beim Erstellen der Vermittlungsstelle.');
            }
        });

        document.getElementById('createUserForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                vorname: document.getElementById('newUserVorname').value.trim(),
                nachname: document.getElementById('newUserNachname').value.trim(),
                email: document.getElementById('newUserEmail').value.trim(),
                passwort: document.getElementById('newUserPasswort').value,
                userTyp: document.getElementById('newUserTyp').value,
                firma: document.getElementById('newUserFirma').value.trim() || null
            };

            try {
                await api('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showUserManageAlert('Benutzer erfolgreich hinzugefügt.', 'success');
                document.getElementById('createUserForm').reset();
                await loadAdminData();
            } catch (error) {
                showUserManageAlert(error.message || 'Fehler beim Hinzufügen des Benutzers.');
            }
        });

        document.getElementById('assignTaskForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const payload = {
                userId: Number(document.getElementById('taskUserId').value),
                titel: document.getElementById('taskTitel').value.trim(),
                status: document.getElementById('taskStatus').value,
                beschreibung: document.getElementById('taskBeschreibung').value.trim() || null,
                faelligAm: document.getElementById('taskFaelligAm').value || null
            };

            try {
                await api('/api/admin/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                showTaskManageAlert('Aufgabe erfolgreich zugeteilt.', 'success');
                document.getElementById('assignTaskForm').reset();
                await loadAdminData();
            } catch (error) {
                showTaskManageAlert(error.message || 'Fehler beim Zuteilen der Aufgabe.');
            }
        });

        (async () => {
            try {
                const ok = await ensureAdmin();
                if (!ok) return;
                await loadAdminData();
            } catch (error) {
                alert(error.message);
            }
        })();
    </script>
</body>
</html>
